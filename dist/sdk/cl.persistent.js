import {clpp} from "./cl.core.js";let g={};const _ = clpp._;var f=function(window){'use strict';var Zy="A persistent DRM session already exists for: ",$y="No DRM configuration.",az="clpp.persistent",bz="clpp.persistent.SimpleSessionStorage",cz=function(a,b){const c=[];for(const d of a)c.push(b(d));return c},ez=function(a,b){a.I=dz;a.J=[];a.C=!0;return _.an(a,b)},gz=function(a,b,c,d,e,f){a.I=fz;const g=new Map,h=_.Lm(b);g.set(h,{audioCapabilities:e,videoCapabilities:f,distinctiveIdentifier:_.Me,persistentState:_.xf,sessionTypes:[_.Re],label:h,drmInfos:[{keySystem:b,licenseServerUri:c,
distinctiveIdentifierRequired:!1,persistentStateRequired:!0,audioRobustness:"",videoRobustness:"",serverCertificate:d,initData:null,keyIds:null}]});return _.$m(a,g)},hz=function(a,b){return _.x(function*(){const c=yield _.rn(a,b);if(c){var d=[],e=a.f.get(c);e&&a.A&&(e.xb=new _.dn,d.push(e.xb));a.g.debug("Attempting to remove session",b);d.push(c.remove());return Promise.all(d)}a.g.debug("Ignoring attempt to remove missing session",b)})},iz=function(a){a=a.f.keys();a=cz(a,b=>b.sessionId);return Array.from(a)},
jz=function(a,b){const c=_.ql(a),d=_.Wk({drm:a});d.drm=a;a=new _.io({vb:b,onError:()=>{},re:()=>{},qe:()=>{},onEvent:()=>{},getConfiguration:()=>d,Bc:()=>null});a.h=c;return a},mz=function(a,b,c){return _.x(function*(){const d=kz;if(a){var e=a.offlineId;if(0!==e.length){var f=yield d.get(e);if(f)lz.debug(Zy,e);else{var g=jz(a,c);try{yield ez(g,b);yield _.pn(g);yield _.sn(g);const h=g.getDrmInfo(),k=b.map(l=>({contentType:_.Nj(l.video.mimeType,l.video.codecs),robustness:h.videoRobustness}));f={sessionIds:iz(g),
keySystem:h.keySystem,licenseServerUri:h.licenseServerUri,serverCertificate:h.serverCertificate,audioCapabilities:[],videoCapabilities:k,drmConfig:a};yield d.store(e,f)}catch(h){throw lz.error(`Error while persisting DRM session ${e}`),new _.H(1,6,6200,null,h);}finally{yield g.destroy()}}}}else lz.debug($y)})},dz=1,fz=2,nz=class{constructor(){this.g=new _.R(bz)}store(a,b){return _.x(function*(){{var c=JSON.stringify(b.sessionIds);var d=b.serverCertificate?Array.from(b.serverCertificate):null;d=JSON.stringify(d);
const e=JSON.stringify(b.audioCapabilities),f=JSON.stringify(b.videoCapabilities);c=JSON.stringify({sessionIds:c,keySystem:b.keySystem,licenseServerUri:encodeURIComponent(b.licenseServerUri),serverCertificate:d,audioCapabilities:e,videoCapabilities:f,drmConfig:JSON.stringify(b.drmConfig)})}window.localStorage.setItem(encodeURIComponent(a),btoa(c))})}get(a){const b=this;return _.x(function*(){const c=window.localStorage.getItem(encodeURIComponent(a));if(c)try{{const e=JSON.parse(atob(c)),f=JSON.parse(e.sessionIds),
g=e.audioCapabilities||[],h=e.videoCapabilities||[],k=e.serverCertificate||[],l=e.drmConfig||{};var d={sessionIds:f,keySystem:e.keySystem,licenseServerUri:decodeURIComponent(e.licenseServerUri||""),serverCertificate:k?new Uint8Array(k):null,audioCapabilities:g,videoCapabilities:h,drmConfig:l}}return d}catch(e){b.g.warn(`Error while loading offline items for ${a} from storage: `,e)}return null})}delete(a){return _.x(function*(){window.localStorage.removeItem(encodeURIComponent(a))})}clear(){return _.x(function*(){window.localStorage.clear()})}getName(){return bz}};_.z("clpp.persistent.useStorage",function(a){{var b=["store","get","delete","clear","getName"];const c=[];_.A(a)||(_.Ug(a.store)||c.push("store"),_.Ug(a.get)||c.push("get"),_.Ug(a.delete)||c.push("delete"),_.Ug(a.clear)||c.push("clear"),_.Ug(a.getName)||c.push("getName"),b=c)}if(0<b.length)throw lz.warn("Invalid session storage implementation"),new _.H(1,6,6202,{missingMethods:b});kz=a});
_.z("clpp.persistent.fetchLicense",function(a,b,...c){return _.x(function*(){var d=kz,e=(l,m)=>new _.H(1,6,6200,l,m);const f=_.bo(a).shift();if(!f)throw e("No source specified.");if(!b)throw e($y);var g=b.offlineId;if(typeof g!==_.Qf||!g.length)throw e("Missing offline id.");if(yield d.get(g))lz.debug(Zy,g);else{var h=_.Wk();d=new _.ap;g=[];for(var k of c){const l=new k;_.Zk(l.id())||(l.f(),_.al(l),g.push(l))}k=null;try{k=yield _.yr(f.url,d,h.manifest.attemptParameters,f.type||null);k.configure(h.manifest);
const l=yield k.start(f.url,{configurationId:"",networkingEngine:d,filterAllPeriods:()=>{},filterNewPeriod:()=>{},onTimelineCueAdded:()=>{},onEvent:()=>{},onError:()=>{}});if(!l.periods.length)throw e(null,new _.H(_.F,4,4014));const m=_.wr(l.periods);yield mz(b,m,d)}catch(l){if(l instanceof _.H&&6200===l.code)throw l;throw e(null,l);}finally{for(;g.length;)e=g.shift(),e.a(),_.Yk.delete(e.id());e=[];k&&e.push(k.stop());e.push(d.destroy());yield Promise.all(e)}}})});
_.z("clpp.persistent.removeLicense",function(a){return _.x(function*(){var b=kz;if(_.Wg(a)&&0!==a.length){var c=null,d=null;try{const e=yield b.get(a);e?(e.drmConfig.delayLicenseRequestUntilPlayed=!0,d=new _.ap,c=jz(e.drmConfig,d),yield gz(c,e.keySystem,e.licenseServerUri,e.serverCertificate,e.audioCapabilities,e.videoCapabilities),yield _.pn(c),yield Promise.all(e.sessionIds.map(f=>_.x(function*(){yield hz(c,f);lz.debug("successfully removed session with id",f)}))),yield b.delete(a)):lz.debug("No persistent DRM session found")}catch(e){throw lz.error("Failed to remove session"),
new _.H(1,6,6201,null,e);}finally{b=[],c&&b.push(c.destroy()),d&&b.push(d.destroy()),yield Promise.all(b)}}else lz.warn("Invalid offlineId")})});var kz=new nz,lz=new _.R(az);_.z("clpp.persistent.PersistentLicenseComponent",class extends _.Yt{constructor(){super();this.g=new _.R(az)}id(){return _.Qe}l(a,b){const c=this;return _.x(function*(){const d=a.getConfiguration().drm;if(d){c.g.debug(`Persisting DRM session ID: ${d.offlineId}`);var e=a.getNetworkEngine();try{yield mz(d,b,e),a.trigger(new _.E(_.Od,{offlineId:d.offlineId}))}catch(f){a.onError(f)}}else c.g.debug("No DRM configuration found for loaded source.")})}j(a){const b=this;return _.x(function*(){b.g.debug(`Getting EME session IDs for ${a}`);
const c=kz;try{const d=yield c.get(a);if(d)return d.sessionIds||[];b.g.debug(`No offline session found for ${a}`);return[]}catch(d){return b.g.warn("Error while loading session info from storage"),[]}})}});};f.call(g, window);