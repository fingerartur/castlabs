(function(){var g={}; var _ = _ || {}
var f=function(window){var vA="A persistent DRM session already exists for: ",wA="No DRM configuration.",xA="clpp.persistent",yA="clpp.persistent.SimpleSessionStorage",zA=function(a,b){for(var c=[],d=_.w(a),e=d.next();!e.done;e=d.next())c.push(b(e.value));return c},AA=function(a){a=a.f.keys();a=zA(a,function(b){return b.sessionId});return Array.from(a)},BA=function(a,b){var c,d,e;return _.I(function(f){if(1==f.a)return _.y(f,_.Fo(a,b),2);c=f.f;if(!c)return a.g.debug("Ignoring attempt to remove missing session",b),f["return"]();
d=[];(e=a.f.get(c))&&a.B&&(e.yb=new _.Rj,d.push(e.yb));a.g.debug("Attempting to remove session",b);d.push(c.remove());return f["return"](Promise.all(d))})},DA=function(a,b){a.K=CA;a.L=[];a.G=!0;return _.go(a,b)},FA=function(a,b,c,d,e,f){a.K=EA;var g=new Map,h=_.Ko(b);g.set(h,{audioCapabilities:e,videoCapabilities:f,distinctiveIdentifier:_.gf,persistentState:_.Uf,sessionTypes:[_.mf],label:h,drmInfos:[{keySystem:b,licenseServerUri:c,distinctiveIdentifierRequired:!1,persistentStateRequired:!0,audioRobustness:"",
videoRobustness:"",serverCertificate:d,initData:null,keyIds:null}]});return _.mo(a,g)},GA=function(){this.g=new _.K(yA)},HA=function(a){a=JSON.parse(a);var b=JSON.parse(a.sessionIds),c=a.audioCapabilities||[],d=a.videoCapabilities||[],e=a.serverCertificate||[],f=a.drmConfig||{};return{sessionIds:b,keySystem:a.keySystem,licenseServerUri:decodeURIComponent(a.licenseServerUri||""),serverCertificate:e?new Uint8Array(e):null,audioCapabilities:c,videoCapabilities:d,drmConfig:f}},IA=function(a,b){var c=
_.Bm(a),d=_.fm({drm:a});d.drm=a;var e=new _.bo({wb:b,onError:function(){},Tf:function(){},Sf:function(){},onEvent:function(){},getConfiguration:function(){return d},Yc:function(){return null}});e.h=c;return e},LA=function(a,b,c){var d,e,f,g,h,l,m,n,p;return _.I(function(q){switch(q.a){case 1:d=JA;e=KA;if(!a)return e.debug(wA),q["return"]();f=a.offlineId;return 0===f.length?q["return"]():_.y(q,d.get(f),2);case 2:if(g=q.f)return e.debug(vA,f),q["return"]();h=IA(a,c);_.D(q,3,4);return _.y(q,DA(h,b),
6);case 6:return _.y(q,_.so(h),7);case 7:return _.y(q,_.zo(h),8);case 8:return l=h.getDrmInfo(),m=b.map(function(u){return{contentType:_.Uk(u.video.mimeType,u.video.codecs),robustness:l.videoRobustness}}),n=AA(h),g={sessionIds:n,keySystem:l.keySystem,licenseServerUri:l.licenseServerUri,serverCertificate:l.serverCertificate,audioCapabilities:[],videoCapabilities:m,drmConfig:a},_.y(q,d.store(f,g),4);case 4:return _.uh(q),_.y(q,h.destroy(),10);case 10:_.vh(q,0);break;case 3:throw p=_.E(q),e.error("Error while persisting DRM session "+
f),new _.N(1,6,6200,null,p);}})},MA=function(){this.g=new _.K(xA)},CA=1,EA=2;_.t=GA.prototype;
_.t.store=function(a,b){var c;return _.I(function(d){var e=JSON.stringify(b.sessionIds),f=b.serverCertificate?Array.from(b.serverCertificate):null;f=JSON.stringify(f);var g=JSON.stringify(b.audioCapabilities),h=JSON.stringify(b.videoCapabilities);c=JSON.stringify({sessionIds:e,keySystem:b.keySystem,licenseServerUri:encodeURIComponent(b.licenseServerUri),serverCertificate:f,audioCapabilities:g,videoCapabilities:h,drmConfig:JSON.stringify(b.drmConfig)});window.localStorage.setItem(encodeURIComponent(a),
btoa(c));_.B(d)})};_.t.get=function(a){var b=this,c;return _.I(function(d){if(c=window.localStorage.getItem(encodeURIComponent(a)))try{return d["return"](HA(atob(c)))}catch(e){b.g.warn("Error while loading offline items for "+a+" from storage: ",e)}return d["return"](null)})};_.t["delete"]=function(a){return _.I(function(b){window.localStorage.removeItem(encodeURIComponent(a));_.B(b)})};_.t.clear=function(){return _.I(function(a){window.localStorage.clear();_.B(a)})};_.t.getName=function(){return yA};_.J("clpp.persistent.useStorage",function(a){var b=["store","get","delete","clear","getName"];var c=[];_.M.S(a)||(_.M.vb(a.store)||c.push("store"),_.M.vb(a.get)||c.push("get"),_.M.vb(a["delete"])||c.push("delete"),_.M.vb(a.clear)||c.push("clear"),_.M.vb(a.getName)||c.push("getName"),b=c);if(0<b.length)throw KA.warn("Invalid session storage implementation"),new _.N(1,6,6202,{missingMethods:b});JA=a});
_.J("clpp.persistent.fetchLicense",function(a,b,c){for(var d=[],e=2;e<arguments.length;++e)d[e-2]=arguments[e];var f,g,h,l,m,n,p,q,u,v,z,A,G,F,C,H,Q,R,na;return _.I(function(da){switch(da.a){case 1:f=JA;g=KA;h=function(Ba,ab){return new _.N(1,6,6200,Ba,ab)};l=_.Fp(a).shift();if(!l)throw h("No source specified.");if(!b)throw h(wA);m=b.offlineId;if(typeof m!==_.mg||!m.length)throw h("Missing offline id.");return _.y(da,f.get(m),2);case 2:if(n=da.f)return g.debug(vA,m),da["return"]();p=_.fm();q=new _.dk;
u=[];v=_.w(d);for(z=v.next();!z.done;z=v.next())A=z.value,G=new A,_.jm(G.id())||(G.f(),_.lm(G),u.push(G));F=null;_.D(da,3,4);return _.y(da,_.Pt(l.url,q,p.manifest.attemptParameters,l.type||null),6);case 6:return F=da.f,F.configure(p.manifest),_.y(da,F.start(l.url,{configurationId:"",networkingEngine:q,filterAllPeriods:function(){},filterNewPeriod:function(){},onTimelineCueAdded:function(){},onEvent:function(){},onError:function(){}}),7);case 7:C=da.f;if(!C.periods.length)throw h(null,new _.N(_.O,
4,4014));H=_.Gt(C.periods);return _.y(da,LA(b,H,q),4);case 4:for(_.uh(da);u.length;)Q=u.shift(),Q.a(),_.im["delete"](Q.id());R=[];F&&R.push(F.stop());R.push(q.destroy());return _.y(da,Promise.all(R),9);case 9:_.vh(da,0);break;case 3:na=_.E(da);if(na instanceof _.N&&6200===na.code)throw na;throw h(null,na);}})});
_.J("clpp.persistent.removeLicense",function(a){var b,c,d,e,f,g,h;return _.I(function(l){switch(l.a){case 1:b=JA;c=KA;if(!_.M.ca(a)||0===a.length)return c.warn("Invalid offlineId"),l["return"]();e=d=null;_.D(l,2,3);return _.y(l,b.get(a),5);case 5:f=l.f;if(!f)return c.debug("No persistent DRM session found"),l["return"]();f.drmConfig.delayLicenseRequestUntilPlayed=!0;e=new _.dk;d=IA(f.drmConfig,e);return _.y(l,FA(d,f.keySystem,f.licenseServerUri,f.serverCertificate,f.audioCapabilities,f.videoCapabilities),
6);case 6:return _.y(l,_.so(d),7);case 7:return _.y(l,Promise.all(f.sessionIds.map(function(m){return _.I(function(n){if(1==n.a)return _.y(n,BA(d,m),2);c.debug("successfully removed session with id",m);_.B(n)})})),8);case 8:return _.y(l,b["delete"](a),3);case 3:return _.uh(l),g=[],d&&g.push(d.destroy()),e&&g.push(e.destroy()),_.y(l,Promise.all(g),10);case 10:_.vh(l,0);break;case 2:throw h=_.E(l),c.error("Failed to remove session"),new _.N(1,6,6201,null,h);}})});var JA=new GA,KA=new _.K(xA);_.x(MA,_.Ts);MA.prototype.id=function(){return _.lf};MA.prototype.l=function(a,b){var c=this,d,e,f;return _.I(function(g){if(1==g.a){d=a.getConfiguration().drm;if(!d)return c.g.debug("No DRM configuration found for loaded source."),g["return"]();c.g.debug("Persisting DRM session ID: "+d.offlineId);e=a.getNetworkEngine();_.D(g,2);return _.y(g,LA(d,b,e),4)}if(2!=g.a)return a.trigger(new _.L(_.le,{offlineId:d.offlineId})),_.th(g,0);f=_.E(g);a.onError(f);_.B(g)})};
MA.prototype.j=function(a){var b=this,c,d;return _.I(function(e){if(1==e.a)return b.g.debug("Getting EME session IDs for "+a),c=JA,_.D(e,2),_.y(e,c.get(a),4);if(2!=e.a){if(d=e.f)return e["return"](d.sessionIds||[]);b.g.debug("No offline session found for "+a);return e["return"]([])}_.E(e);b.g.warn("Error while loading session info from storage");return e["return"]([])})};_.J("clpp.persistent.PersistentLicenseComponent",MA);};
if(typeof(module)!="undefined"&&module.exports){var x=require("./cl.core.js");_ = x._;(f.call(g,this));module.exports=g;}
else if (typeof(define)!="undefined"&&define.amd) {define(["./cl.core"], function(c){_=c._;(f.call(g,this));return g;});}
else{_=this.clpp._;(f.call(g,this));}
})();