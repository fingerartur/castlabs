(function(){var g={}; var _ = _ || {}
var f=function(window){var ry="No thumbnail found for position: ",sy="Position is out of range: ",ty="Thumbnail URL is mandatory",uy="Wrong gridSize format",vy="clpp.thumbnails",wy=function(){this.log=new _.K(vy);this.player=null;this.a=[];this.w=!1},yy=function(a,b){b.reduce(function(c,d){var e=d,f=!1;typeof d===_.$e&&(e=d.step,f=d.preloadWhileBuffering);return c.then(function(){return xy(a,0,e,!!f)})},Promise.resolve())},xy=function(a,b,c,d){if(a.w||b>=a.a.length)return Promise.resolve();var e=b+c;return zy(a,d).then(function(){return a.a[b].load()}).then(function(){return xy(a,
e,c,d)})},zy=function(a,b){return new Promise(function(c){if(b||a.player.getState()!==_.sp)c();else a.player.one(_.nd,function(){c()})})},Ay=function(a,b,c,d,e,f,g,h,l,m,n,p){d=void 0===d?0:d;e=void 0===e?0:e;f=void 0===f?0:f;g=void 0===g?0:g;h=void 0===h?1:h;l=void 0===l?1:l;m=void 0===m?0:m;n=void 0===n?0:n;p=void 0===p?new Image:p;this.time=b;this.src=a;this.duration=c;this.x=d;this.y=e;this.width=f;this.height=g;this.qa=p;this.pk=h;this.bn=l;this.il=m;this.jl=n;this.Kf=null},By=function(){wy.call(this);
this.f=null;this.o=this.h=1;this.j=0},Cy=function(a,b){this.time=a;this.duration=0;this.offset=b;this.length=0;this.Wd=new _.Rj},Dy=function(){this.g=new _.K(vy);this.f=new ArrayBuffer(0);this.a=[];this.h=new _.Rj},Ey=function(a){var b=a.f.byteLength;a.a.forEach(function(c){c.offset+c.length<b&&c.Wd.resolve()})},Gy=function(a,b){return Fy(a,b).then(function(c){return new Ay(c,b.time,b.duration)})},Fy=function(a,b){return b.load().then(function(){var c=_.oj(a.f,b.offset,b.length);return"data:image/jpeg;base64,"+
_.yj(c)})},Hy=function(){wy.call(this);this.f=null},Iy=function(a){a=a.split(/\.|:/).map(parseFloat);var b=0,c,d={3:.001,2:1,1:60,0:3600};for(c=a.length-1;0<=c;c--)b+=a[c]*d[c];return b},Jy=function(){wy.apply(this,arguments)},Ky=function(a,b){var c=a.horizontalTiles||b.horizontalTiles||1,d=a.verticalTiles||b.verticalTiles||1,e=c*d;return{Md:c,tg:d,Bh:e,durationPerTile:a.durationPerTile||b.durationPerTile||(a.endTime-a.startTime)/e}},Ly=function(){this.g=new _.K(vy);this.a=this.m=null},My=function(a){return a.some(function(b){return 0<
b.thumbStreams.length})},Ry=function(a){return a?a===Ny||a===Oy?new By:a===Py?new Hy:a===Qy?new Dy:null:null},Sy=function(a){if(!a)return null;a=new _.tk(a);return a.path.match(/.*\.vtt$/i)?Py:a.path.match(/.*\.bif$/i)?Qy:a.path.match(/.*\.(png|jpg|jpeg)$/i)?Ny:null},Ty=function(){};wy.prototype.init=function(a,b){var c=this;this.player=a;a.one(_.Sf,function(){c.w=!0});a.isLive()||this.l().then(function(){b&&b.preload&&yy(c,b.preload)})};Ay.prototype.raw=function(){return this.qa.cloneNode(!1)};
Ay.prototype.element=function(a,b){var c=this.width,d=this.height,e=this.width/this.height;void 0!==a&&void 0===b&&(b=0);null!==a&&void 0!==a&&(c=a);null!==b&&void 0!==b&&(d=b);c||(c=Math.ceil(d*e));d||(d=Math.ceil(c/e));e=document.createElement(_.be);e.style.width=c+_.Pf;e.style.height=d+_.Pf;e.style.backgroundColor="#000";e.style.backgroundRepeat="no-repeat";e.style.backgroundImage='url("'+this.src+'")';e.style.backgroundSize=Math.ceil(c/this.width*(this.qa.naturalWidth||this.qa.width))+"px "+Math.ceil(d/
this.height*(this.qa.naturalHeight||this.qa.height))+_.Pf;var f=this.y/this.height;e.style.backgroundPositionX="-"+this.x/this.width*c+_.Pf;e.style.backgroundPositionY="-"+f*d+_.Pf;return e};
Ay.prototype.load=function(){var a=this;this.Kf||(this.Kf=new Promise(function(b,c){function d(){a.width||(a.width=(a.qa.naturalWidth||a.qa.width)/a.pk);a.height||(a.height=(a.qa.naturalHeight||a.qa.height)/a.bn);a.x||(a.x=a.width*a.il);a.y||(a.y=a.height*a.jl)}if(a.qa.src&&a.qa.complete)d(),b(a);else{var e=null,f=function(){d();a.qa.removeEventListener("load",f);a.qa.removeEventListener(_.te,e);b(a)};e=function(g){a.qa.removeEventListener("load",f);a.qa.removeEventListener(_.te,e);c(new _.N(1,9,
2014,"Failed to load thumbnail.",g))};a.qa.addEventListener("load",f);a.qa.addEventListener(_.te,e);a.qa.src=a.src}}));return this.Kf};_.J("clpp.thumbnails.Thumbnail",Ay);Ay.prototype.load=Ay.prototype.load;Ay.prototype.element=Ay.prototype.element;Ay.prototype.raw=Ay.prototype.raw;_.x(By,wy);
By.prototype.init=function(a,b){if(!b||!b.url)throw new _.N(1,9,7100,ty);if("GRID"===b.mode&&!b.gridSize)throw new _.N(1,9,7100,"Grid size is mandatory for GRID mode");if(!b.duration)throw new _.N(1,9,7100,"Duration is mandatory");this.f=b;this.j=this.f.duration;if(this.f.gridSize)try{var c=this.f.gridSize.split(/x/).map(function(d){return parseInt(d,10)}).filter(function(d){return 0<d});if(2===c.length)this.h=c[0],this.o=c[1];else throw new _.N(1,9,7100,uy);}catch(d){throw this.log.error("Error during parsing gridSize",d),
new _.N(1,9,7100,uy);}wy.prototype.init.call(this,a,b)};By.prototype.get=function(a){var b=this,c,d,e,f;return _.I(function(g){if(1==g.a){c=b.player.getDuration();if(0>a||a>c)throw new _.N(1,9,2014,sy+a);d=b.f.duration;e=Math.floor(a/d);f=b.a[e];if(!f)throw new _.N(1,9,2014,"No thumbnail found for position "+a+" at index "+e);return _.y(g,f.load(),2)}return g["return"](f)})};
By.prototype.l=function(){if(0<this.a.length)return Promise.resolve();var a=this.player.getDuration(),b=this.h*this.o;a=Math.ceil(Math.ceil(a/this.j)/b);for(var c=this.f.templateKey||"$index$",d=0;d<a;d++)for(var e=this.f.url.replace(c,String(d+1)),f=new Image,g=0;g<b;g++)this.a.push(new Ay(e,this.j*(d*b+g),this.j,0,0,0,0,this.h,this.o,g%this.h,Math.floor(g/this.h),f));return Promise.resolve()};Cy.prototype.load=function(){return this.Wd};
Dy.prototype.init=function(a,b){var c=this;if(!b||!b.url)throw new _.N(1,9,7100,ty);var d=b.url,e=_.Mj(d);e.type=_.Lj;a.getNetworkEngine().fetch(e).P.then(function(f){f=f.data;var g=_.oj(c.f);f=_.oj(f);for(var h=g.byteLength+f.byteLength,l=new ArrayBuffer(h),m=new DataView(l),n=0,p=0,q=g.byteLength;p<q;p++)m.setUint8(n,g[p]),n+=1;g=0;for(p=f.byteLength;g<p;g++)m.setUint8(n,f[g]),n+=1;c.f=l;c.g.info("Appended "+f.byteLength+" bytes.Total data now "+(h+" bytes."));l=c.f;f=_.oj(l);n=String.fromCharCode.apply(null,
Uy);g=Array.prototype.slice.call(f,0,8);f=64;h=0;m=!1;if(n===String.fromCharCode.apply(null,g))for(l=new DataView(l,16,20),l=l.getUint32(0,!0),0===l&&(l=1E3);!m;){h+=1;g=l;n=new DataView(c.f,f);m=n.getUint32(0,!0);g=m*g/1E3;n=n.getUint32(4,!0);n=new Cy(g,n);if(g=c.a.length)g=c.a[g-1],g.length=n.offset-g.offset,g.duration=n.time-g.time;c.a.push(n);f+=8;(m=4294967295===m)&&c.h.resolve();if(1E5<h)throw Error("There was a problem during reading BIF entries");}else throw Error("The file is not a valid BIF format");
Ey(c)})["catch"](function(f){c.g.error("[BIF] Error while loading thumbnails '\n            + 'URL: "+d,f);a.onError(new _.N(1,9,2013,"Error while loading and parsing BIF thumbnails.",f))})};Dy.prototype.get=function(a){var b=this,c,d;return _.I(function(e){switch(e.a){case 1:if(0>a)throw new _.N(1,9,2014,sy+a);return _.y(e,b.h,2);case 2:c=b.a.find(function(f){return a>=f.time&&a<f.time+f.duration});if(!c)throw new _.N(1,9,2014,ry+a);return _.y(e,Gy(b,c),3);case 3:return d=e.f,_.y(e,d.load(),4);case 4:return e["return"](d)}})};
Dy.prototype.Ld=function(){return 0<this.a.length};var Uy=[137,66,73,70,13,10,26,10];_.x(Hy,wy);
Hy.prototype.init=function(a,b){var c=this;if(!b||!b.url)throw new _.N(1,9,7100,ty);var d=b.url,e=_.Mj(d);e.type=_.Lj;this.f=a.getNetworkEngine().fetch(e).P.then(function(f){f=f.data;if(!f)throw Error("No data in the response");f=_.S.ba(f).split(/\n/);for(var g=0;g<f.length;g++){var h=f[g],l=h.split(" --\x3e ");if(2===l.length){h=f[++g];var m=h.indexOf("\x3d"),n=0>m?[]:h.substr(m+1).split(/,/).map(parseFloat);m=n[0];var p=n[1],q=n[2];n=n[3];var u=h.indexOf("#");h=0>u?h:h.substr(0,u);h.match(/^http|^\/\//)||(h=
d.substr(0,d.lastIndexOf("/"))+"/"+h);u=Iy(l[0]);l=Iy(l[1])-u;c.a.push(new Ay(h,u,l,m,p,q,n,0,0))}}})["catch"](function(f){c.log.error("[VTT] Error while loading thumbnails URL: "+d,f);a.onError(new _.N(1,9,2013,"Error while loading VTT thumbnails.",f))});wy.prototype.init.call(this,a,b)};
Hy.prototype.get=function(a){var b=this,c;return _.I(function(d){if(1==d.a){if(0>a)throw new _.N(1,9,2014,sy+a);return _.y(d,b.f,2)}if(3!=d.a){c=b.a.find(function(e){return a>=e.time&&a<e.time+e.duration});if(!c)throw new _.N(1,9,2014,ry+a);return _.y(d,c.load(),3)}return d["return"](c)})};Hy.prototype.l=function(){return this.f};_.x(Jy,wy);
Jy.prototype.get=function(a){function b(){return new _.N(1,9,2014,ry+a)}var c=this,d,e,f,g,h,l,m,n,p,q,u,v,z;return _.I(function(A){if(1==A.a){if(0>a)throw c.log.error("Position must be greater than 0 but is "+a),new _.N(1,9,2014,sy+a);d=c.player.getPeriods();for(var G=null,F=_.w(d),C=F.next();!C.done;C=F.next())C=C.value,C.startTime<=a&&(G=C);e=G;if(!e)throw c.log.error("Could not find period for specified position",a),b();f=e.thumbStreams.sort(c.f)[0];if(!f)throw c.log.error("Could not find thumb stream for specified position",a),
b();g=f.findSegmentPosition(a-e.startTime);if(null===g||void 0===g)throw c.log.error("Could not find segment index for specified position",a),b();h=f.getSegmentReference(g);if(!h)return A.F(2);l=Ky(h,f);m=Math.floor((a-h.startTime)/l.durationPerTile);0<c.a.length?(p=f.findSegmentPosition(0),null!==p&&(n=c.a[(g-p)*l.Bh+m])):(q=h.Sa())&&0<q.length&&(v=u=0,z=h.startTime,1<l.Bh&&(u=m%l.Md,v=Math.floor(m/l.Md),z+=m*l.durationPerTile),n=new Ay(q[0],z,l.durationPerTile,void 0,void 0,void 0,void 0,l.Md,l.tg,
u,v));return n?_.y(A,n.load(),4):A.F(2)}if(2!=A.a)return A["return"](n);c.log.error("segment reference for specified segment index does not exist",g);throw b();})};Jy.prototype.f=function(a,b){return void 0!==a.bandwidth&&void 0!==b.bandwidth?a.bandwidth-b.bandwidth:0};
Jy.prototype.l=function(){if(0<this.a.length)return Promise.resolve();var a=this.player.getPeriods();a=_.w(a);for(var b=a.next();!b.done;b=a.next())if(b=b.value.thumbStreams.sort(this.f)[0])for(var c=b.findSegmentPosition(0),d=void 0;null!==c&&!_.M.S(d=b.getSegmentReference(c++));)for(var e=Ky(d,b),f=d.Sa()[0],g=new Image,h=d.startTime,l=0;l<e.tg;++l)for(var m=0;m<e.Md;++m)this.a.push(new Ay(f,h,e.durationPerTile,void 0,void 0,void 0,void 0,e.Md,e.tg,m,l,g)),h+=e.durationPerTile;return Promise.resolve()};_.t=Ly.prototype;_.t.onPlayerCreated=function(a){this.m=a};_.t.onPlayerWillDestroy=function(){this.m=null};_.t.onPlayerWillRelease=function(){this.a=null};
_.t.onContentWillLoad=function(a){var b=this,c=a.getConfiguration().thumbnails;if(c)if(!1===c.enabled)this.g.info("Thumbnails disabled.");else{var d=c.mode||null;d||(d=Sy(c.url||null));(this.a=Ry(d))?(this.g.info("Loading thumbs configuration",c),this.m.one(_.Ne,function(){b.g.info("Initialize thumbnails provider");try{b.a.init(a,c)}catch(e){b.m.onError(e)}})):this.g.warn("Unknown thumbnail mode",d)}else this.a=null};
_.t.onContentLoaded=function(a,b){for(var c=1;c<arguments.length;++c);if(!this.a&&(c=(c=a.getConfiguration())&&c.thumbnails,!c||void 0===c.enabled||c.enabled)){var d=a.getPeriods();if(My(d)){this.a=new Jy;try{this.a.init(a,c)}catch(e){this.m.onError(e)}}}};_.t.get=function(a){return this.a?this.a.get(a):Promise.reject(new _.N(1,9,2014,"Thumbnail format is not supported"))};_.t.id=function(){return"thumbnails"};_.J("clpp.thumbnails.ThumbnailsPlugin",Ly);Ly.prototype.get=Ly.prototype.get;Ly.Id="thumbnails";
Ty.prototype.create=function(){return new Ly};_.br(new Ty);var Ny="SINGLE",Oy="GRID",Py="WEBVTT",Qy="BIF";};
if(typeof(module)!="undefined"&&module.exports){var x=require("./cl.core.js");_ = x._;(f.call(g,this));module.exports=g;}
else if (typeof(define)!="undefined"&&define.amd) {define(["./cl.core"], function(c){_=c._;(f.call(g,this));return g;});}
else{_=this.clpp._;(f.call(g,this));}
})();