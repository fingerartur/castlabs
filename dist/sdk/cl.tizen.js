import {clpp} from "./cl.core.js";import './cl.mse.js';let g={};const _ = clpp._;var f=function(window){'use strict';var MM="An unknown error occurred while trying to get volume",NM="Cannot get loading rendition due to platform limitations",OM="SecurityError",PM="The require privilege is: http://tizen.org/privilege/tv.audio",QM="|STARTBITRATE\x3d",RM=function(a,b,c){const d=e=>{c.call(a,e);a.removeEventListener(b,d)};a.addEventListener(b,d)},UM=function(a){return _.x(function*(){if(a.a!==_.zd&&a.a!==_.xd)throw new _.H(_.F,6,6001,`The key system ${a.a} is not supported by `+"the player or the platform");
const b=a.f.get(a.a);if(!b.dd)throw new _.H(_.F,6,6012,`No license server given for ${a.a}`);try{a.a===_.zd?yield SM(a):yield TM(a,b),a.o={keySystem:a.a,licenseServerUri:b.dd,distinctiveIdentifierRequired:!1,persistentStateRequired:b.te,audioRobustness:"",videoRobustness:"",serverCertificate:null,initData:[],keyIds:[],periodId:null}}catch(c){throw a.g.error(`Error while configuring CDM for ${a.a}`,c),new _.H(_.F,6,6005,{message:JSON.stringify(c)});}})},WM=function(a,b){_.x(function*(){var c=a.f.get(a.a);
a.g.debug("DRM Challenge data: ",b.challenge);const d=atob(b.challenge);var e=new Uint8Array(d.length);for(let h=0;h<d.length;++h)e[h]=d.charCodeAt(h);c=_.Si([b.serverurl&&""!==b.serverurl?b.serverurl:c.dd],_.Pi());c.type=3;c.body=e.buffer;c.method=_.ub;try{var f=yield a.D.vb.fetch(c).R;if(a.j){var g=_.J(f.data);const h=g.byteLength;e="";for(f=0;f<h;f++)e+=String.fromCharCode(g[f]);const k=`${b.session_id}PARAM_START_POSITION`+`${btoa(e)}PARAM_START_POSITION`;a.g.debug("Widevine license params",k);
try{webapis.avplay.setDrm(VM,"widevine_license_data",k)}catch(l){a.g.error("License response rejected by CDM");const m=new _.H(_.F,6,6008,{browserError:JSON.stringify(l)});a.D.onError(m)}}}catch(h){a.g.error("License request failed.",JSON.stringify(h)),g=new _.H(_.F,6,6007,{message:_.Sa,url:h.data.url,status:h.data.status||NaN,response:h.data.response||"",headers:h.data.headers||{}},h),a.D.onError(g)}})},SM=function(a){return _.x(function*(){try{webapis.avplay.setDrm(VM,"Initialize",""),webapis.avplay.setDrm(VM,
"widevine_app_session",a.l.id),webapis.avplay.setDrm(VM,"widevine_data_type",a.l.type)}catch(b){throw b;}})},TM=function(a,b){return _.x(function*(){var c={};c[XM]=!b.te;c[YM]=b.dd;""!==b.customData&&(c[ZM]=b.customData);c=JSON.stringify(c);a.g.debug("PlayReady properties: ",c);try{webapis.avplay.setDrm($M,"SetProperties",c)}catch(d){throw d;}})},bN=function(a,b){if(a.f!==b)if(a.f===_.Vn&&b!==_.Wn)a.g.debug(_.fA+`${aN(b)}`);else{var c=(new Date).getTime();a.j=a.f;a.f=b;a.f===_.Rn?(a.o=(new Date).getTime(),
a.m.trigger(new _.E(_.Uc,{detail:{bufferedTimeMS:-1,reason:a.h}}))):a.j===_.Rn&&a.m.trigger(new _.E(_.Qc,{detail:{bufferedTimeMS:c-a.o,reason:a.h}}));b={currentState:a.f,previousState:a.j,timeSinceLastStateChangeMS:c-a.w};a.w=c;a.m.trigger(new _.E(_.Nf,{detail:b}));a.g.debug("State changed:",aN(a.j),"-\x3e",aN(a.f))}},aN=function(a){return Object.keys(_.Un)[a]},eN=function(a){if(a.l){var b=a.a.getState(),c=a.f;switch(b){case cN:c=_.Zn;break;case dN:c=_.Yn;break;default:a.m.isEnded()?c=_.On:a.g.debug("Inconsistent AVPlay playback state:",
b)}bN(a,c)}},fN=function(a){return _.x(function*(){const b=a.m.getConfiguration();let c;(c=yield _.yr(a.B.url,a.m.getNetworkEngine(),b.manifest.attemptParameters,a.B.type||null))&&c.configure(b.manifest);return c})},gN=function(a){if(!a)return!1;a=a.periods;let b=!1;for(let c=0;c<a.length;c++)b=b||0<a[c].textStreams.length;return b},hN=function(a){const b=document.createElement(_.w),c=new _.yG,d=new _.FF,e=a.m.getTextDisplayer();return new _.AG(b,c,e,d,a.m.getConfiguration())},iN=function(a){const b=
{configuration:{},Db:()=>a.m.getPosition(),$:a.h,vb:a.m.getNetworkEngine(),oe:a.G.bind(a),ne:a.F.bind(a),onError:a.U.bind(a),zf:()=>{},onEvent:()=>{},Cf:a.H.bind(a),Kd:()=>{},vd:()=>new _.rH,Td:()=>!1,Oc:null};return new _.SG(a.a,b)},jN=function(a){const b=a.m.getPosition();let c=null;for(const d of a.a.periods)d.startTime<=b&&(c=d);return c},kN=function(a){a.g.debug("getTextStreams()",a.a);if(a.a){var b=[],c=a.a.periods;a.g.debug("getting text streams");for(var d=0;d<c.length;d++)if(a.g.debug(c[d].startTime,
a.m.getPosition()),c[d].startTime<=a.m.getPosition()){b=c[d].textStreams;break}a=b}else a=[];b=[];c=0;for(d=0;d<a.length;d++){const e=new _.hj(String(c++),_.K);e.mimeType=a[d].mimeType;e.language=a[d].language;e.roles=a[d].roles;e.kind=a[d].kind||_.NA;const f=new _.pj(String(a[d].id),e);f.bandwidth=a[d].bandwidth||null;e.renditions.push(f);b.push(e)}return b},lN=function(a){if(a.h&&!a.h.getTextDisplayer().isTextVisible())return null;if(a.f){const b=_.BE(a.f,_.G);let c=null;if(b){a=kN(a);for(let d=
0;d<a.length;d++)if(a[d].renditions[0].id===String(b.id)){c=a[d].renditions[0];break}}return c}return null},mN=function(a,b){a.g.debug("Set active track",b);if(b&&(a.o=b.language,a.A=b.roles[0]||"",a.C=b.kind===_.Wd,a.a&&a.f)){a.setTextVisibility(!0);const c=jN(a),d=b.renditions[0];(b=c.textStreams.find(e=>String(e.id)===d.id))?(a.w?(a.g.debug("Switching period defer text selection"),a.l=b):(_.QE(a.f,b,!0,0),a.m.trigger(new _.E(_.Kk))),a.o=b.language):a.g.error(_.eA,d.id)}},nN=function(a){const b=
a.oa();b&&a.m.trigger(new _.E(_.Nc,{detail:{width:b.width,height:b.height,bandwidth:b.bandwidth,rendition:b}}))},oN=function(a,b){a.m.trigger(new _.E(_.rg,{details:{width:b.width,height:b.height,bandwidth:b.bandwidth,track:b.track,abrSelection:a.a.o}}))},pN=function(a,b){let c=null;try{c=JSON.parse(b)}catch(d){a.g.warn("Couldn't retrieve extra infos from stream."),c=null}return c},qN=function(a,b){a=a.f[_.N]||[];const c=[];for(let d=0;d<a.length;d++)for(let e=0;e<a[d].renditions.length;e++)_.Yg(a[d].renditions[e],
b,Object.keys(b))&&c.push(a[d].renditions[e]);return c[0]||null},rN=function(a){const b=a.m.getConfiguration();var c=_.Ah(b.preferredAudioLanguage||[]);const d=a.f[_.L]||[];if(d.length){var e=null;c.some(g=>{e=_.gB(g,d.map(h=>h.language));return!!e});if(e){var f=d.filter(g=>g.language===e);c=f[0];1<f.length&&b.preferredAudioRole&&(f=f.filter(g=>0<=g.roles.indexOf(b.preferredAudioRole)),0<f.length&&(c=f[0]));a.g.debug("Setting audio track with preferred language:",e);a.wa(c)}else a.g.debug("Preferred language(s) not available")}else a.g.debug("Could not set preferred audio language")},
xN=function(a,b){var c=(l,m)=>{for(let n=0;n<l.length;n++)if(l[n].language===m)return l[n];return null};const d={};if(0>=b.length)return d;var e=b.filter(l=>l.type===sN),f=b.filter(l=>l.type===tN);const g=[];for(var h=0;h<f.length;h++){const l=pN(a,f[h].extra_info);if(l){var k=_.bi(l.language||_.ag);k=_.dj(k);k=c(g,k);k||(k=new _.hj(String(a.o++),_.L),g.push(k));k.renditions.push(uN(f[h].index,l,k))}else a.g.warn("Skipping audio stream with no extra info")}c=new _.hj(String(a.o++),_.N);for(f=0;f<
e.length;f++)(h=pN(a,e[f].extra_info))?c.renditions.push(vN(e[f].index,h,c)):a.g.warn("Skipping video stream with no extra info");e=[];e=a.h?kN(a.h):wN(a,b);d[_.N]=[c];d[_.L]=g;d[_.K]=e;return d},AN=function(a,b){if(b===_.K&&a.h)return lN(a.h);var c=yN(a.a)||[];if(0===c.length)return null;c=c.filter(e=>e.type===b.toUpperCase())[0];var d=null;b===_.N&&(d=pN(a,c.extra_info),d=qN(a,{width:d.Width,height:d.Height}));b===_.L&&(c?(d=zN(a,c,_.L),a.j=d):d=a.j);b===_.K&&(c?(d=zN(a,c,_.K),a.l=d):d=a.l);return d},
DN=function(a,b){if(b){const c=b.track.type.toUpperCase();BN(a.a,c,Number(b.id)).then(()=>{c===tN&&(a.j=b,a.m.trigger(new _.E(_.Jk)));c===CN&&(a.l=b,a.m.trigger(new _.E(_.Kk)))}).catch(()=>{a.g.error("Could not select "+c+" track.")})}else a.g.debug("Must provide valid rendition")},uN=function(a,b,c){const d=_.bi(b.language||_.ag);c.language=_.dj(d);c.originalLanguage=d;c.channelsCount=b.channels?Number(b.channels):null;c.mimeType=_.Jc;a=new _.pj(String(a),c);a.track=c;a.codec=b.fourCC||null;a.bandwidth=
b.bit_rate||null;return a},vN=function(a,b,c){c.mimeType=_.mg;a=new _.pj(String(a),c);a.track=c;a.width=b.Width||null;a.height=b.Height||null;a.bandwidth=b.Bit_rate?Number(b.Bit_rate):null;a.codec=b.fourCC||null;return a},EN=function(a,b,c){b=_.bi(b.track_lang||_.ag);c.mimeType="text/ttml";c.language=_.dj(b);c.originalLanguage=b;c.kind=_.NA;return new _.pj(String(a),c)},wN=function(a,b){b=b.filter(d=>d.type===CN);const c=[];for(let d=0;d<b.length;d++){const e=pN(a,b[d].extra_info);if(!e){a.g.warn("Skipping text stream with no extra info");
continue}const f=new _.hj(String(a.o++),_.K);f.renditions.push(EN(b[d].index,e,f));c.push(f)}return c},zN=function(a,b,c){a=a.f[c]||[];b=String(b.index);c=null;for(let d=0;d<a.length;d++)for(let e=0;e<a[d].renditions.length;e++)if(a[d].renditions[e].id===b){c=a[d].renditions[e];break}return c},FN=function(a){return a.f&&a.a?a.a.zh:webapis.avplay.getTotalTrackInfo()},HN=function(a,b,c){a.g.debug("switchVideoTrack()");try{const d={estimatedBandwidth:parseInt(webapis.avplay.getStreamingProperty("CURRENT_BANDWITH"),
10),currentBandwidth:b,nextBandwidth:c,currentPosition:a.getPosition()};a.a=GN(a);a.f=!0;webapis.avplay.stop();webapis.avplay.close();return a.load(a.m.getConfiguration(),d).then(()=>{const e=a.a.We;a.f=!1;a.a=null;return e===dN?a.pause():a.play()})}catch(d){return Promise.reject(d)}},IN=function(a,b){var c=a.m.getTextDisplayer();c&&c.setTextVisibility(b);c=a.m.h;try{c||webapis.avplay.setSilentSubtitle(!b)}catch(d){a.g.debug("Could not set text track visibility",d)}},BN=function(a,b,c){b=b.toUpperCase();
b===CN&&IN(a,!0);const d=a.j[b];d&&(d.Nd.stop(),a.j[b]=null,a.g.debug(`Cancelled pending track switch for ${b}`));return new Promise((e,f)=>{const g=(h,k,l)=>{l=void 0===l?!1:l;try{webapis.avplay.setSelectTrack(h,k),a.j[h]=null,e()}catch(m){a.g.debug(`Could not set ${h} track. Trying again...`+`AVPlay state: ${a.getState()}, `+`buffering: ${a.w}`,m),!1===l&&(a.j[h]={type:h,index:k,Te:0,Nd:new _.Tj(()=>g(h,c,!0))}),(k=a.j[h])&&3>k.Te?(!a.w&&++k.Te,k.Nd.ha(a.w?.5:.25)):(a.g.debug("Could not set track after multiple attempts.Giving up..."),
k&&k.Nd.stop(),a.j[h]=null,f())}};g(b,c)})},yN=function(a){return a.f&&a.a?a.a.ng:webapis.avplay.getCurrentStreamInfo()},JN=function(a){return _.x(function*(){tizen.systeminfo.getPropertyValue("DISPLAY",b=>{a.A=b.resolutionWidth/1920;a.g.debug("Display resolution ratio: ",a.A)},b=>{a.g.debug("Could not load DISPLAY property");throw b;})})},LN=function(a){try{webapis.avplay.setListener({onbufferingstart:a.I.bind(a),onbufferingprogress:a.H.bind(a),onbufferingcomplete:a.G.bind(a),onstreamcompleted:a.L.bind(a),
oncurrentplaytime:b=>{a.trigger(new _.E(KN,{currentTime:b}))},onevent:a.K.bind(a),onsubtitlechange:a.N.bind(a),ondrmevent:a.J.bind(a),onerror:a.U.bind(a)})}catch(b){a.g.error(b)}},MN=function(a){const b=!!a.m.getTrackManager().Ia();try{webapis.avplay.setSilentSubtitle(!b)}catch(c){a.g.debug("Could not set AVPlay subtitle config",c)}},NN=function(a,b){try{const c=b.estimatedBandwidth||0,d=b.currentBandwidth||0;a.g.debug({estimatedBandwidth:c,Ph:d});0!==c&&0!==d&&c>=1.15*d&&webapis.avplay.setStreamingProperty("ADAPTIVE_INFO",
QM+d)}catch(c){a.g.debug(c)}},ON=function(a,b){try{webapis.avplay.setStreamingProperty("ADAPTIVE_INFO","|BITRATES\x3d"+b+QM+b)}catch(c){throw a.g.debug("Could not set fixed bandwidth",c),c;}},PN=function(a){let b=null;try{b=tizen.tvaudiocontrol.isMute()}catch(c){switch(c.name){case OM:a.g.warn("The application doesn't have the privilege to get the mute state.",PM);break;default:a.g.warn(MM,c)}}return!!b},GN=function(a){return{position:a.getPosition(),state:a.m.getState(),We:a.getState(),playbackRate:a.getPlaybackRate(),
isLive:a.isLive(),duration:a.getDuration(),isMuted:PN(a),volume:a.getVolume(),zh:FN(a),ng:yN(a)}},QN=function(){return new Promise((a,b)=>{if(window.webapis)a();else{const c=document.createElement("script");RM(c,"load",d=>a(d));RM(c,_.r,d=>b(d));c.src="$WEBAPIS/webapis/webapis.js";document.querySelector("head").appendChild(c)}})},RN=function(a){return _.x(function*(){yield QN();const b=new Promise(c=>{(new _.Tj(c)).ha(5)});if(!(yield Promise.race([JN(a).then(()=>!0),b.then(()=>!1)])))return a.g.debug("Took to long for the SDK to be ready"),
Promise.reject("SDK Timeout")})},SN=function(a){return _.x(function*(){a.g.debug("avplay.prepare()");return new Promise((b,c)=>{try{webapis.avplay.prepareAsync(()=>{a.g.debug("AVPlay is ready!");MN(a);b()},d=>{a.g.debug("prepareAsync failed",d);c(d)})}catch(d){a.g.debug("Failed to prepare media player for playback"),c(d)}})})},TN=function(a,b){try{tizen.tvaudiocontrol.setMute(b)}catch(c){switch(c.name){case OM:a.g.warn("The application does not have the privilege to set mute.",PM);break;default:a.g.warn(MM,
c)}}},YN=function(a,b,c){return _.x(function*(){a.l=_.bo(b);const d=a.F,e=c||{estimatedBandwidth:0,currentBandwidth:0,nextBandwidth:null,currentPosition:0};a.g.debug(`Loading manifest URL: ${a.l[d].url}`);let f=b.startTime||void 0;a.f&&(a.trigger(new _.E(UN)),f=c.currentPosition);try{let g=a.l[d].url;if(a.l[d].type===_.zc&&!g.includes(".mpd")){const h=new URL(g);h.searchParams.append("cl-ext",".mpd");g=h.toString()}webapis.avplay.open(g);e.nextBandwidth?(ON(a,e.nextBandwidth),a.o=!1):(a.o||NN(a,e),
a.o=!0);LN(a);if(b.drm&&b.drm.env){const h={onError:k=>a.m.onError(k),vb:a.m.getNetworkEngine()};a.h=new VN(b.drm,h);yield a.h.init()}else a.g.debug("No DRM configuration was provided. Assuming clear content");a.f||a.trigger(new _.E(WN));yield SN(a);a.f||a.trigger(new _.E(XN));f&&typeof f===_.t&&0<f&&a.seek(f).catch(h=>{a.g.debug("Couldn't set start position",h)});a.f||(b.volume&&a.setVolume(b.volume),b.muted&&TN(a,b.muted),b.autoplay&&a.m.play().catch(h=>{a.g.debug("Autoplay failed",h)}))}catch(g){throw a.g.debug("Error while attempting to load source."),
g;}})},ZN=function(a){if("NONE"!==a.a.getState()){var b=a.j.getBoundingClientRect();{a=a.a;const c=Math.floor(b.left*a.A),d=Math.floor(b.top*a.A),e=Math.floor(b.width*a.A);b=Math.floor(b.height*a.A);a.g.debug("Setting display area to","x:",c,"y:",d,"width:",e,"height:",b);webapis.avplay.setDisplayRect(c,d,e,b);0===c&&0===d&&1920===e&&1080===b&&webapis.avplay.setDisplayMethod("PLAYER_DISPLAY_MODE_LETTER_BOX")}}else a.g.debug("Could not apply dimension. Player state "+a.a.getState())},VN=class{constructor(a,
b){this.h=a;this.o=null;this.a=_.Ee;this.l=null;this.j=!1;this.f=new Map;this.D=b;this.g=new _.R("clpp.tizen.DrmEngine")}init(){const a=this;return _.x(function*(){var b=_.nl[a.h.env]||null;if(!b)throw a.g.debug(_.va,_.zb+a.h.env+_.aa),new _.H(_.F,6,6015,`DRM environment '${a.h.env}' is missing.`);a.l={id:String(Math.floor(1E4*Math.random())),type:"MPEG-DASH"};var c=Object.keys(a.h.customData||{}).length?btoa(JSON.stringify(a.h.customData)):"";b=_.pl(b,a.h.customData);const d=b[_.xd];d&&a.f.set(_.xd,
{dd:d.licenseUrl||"",customData:c,te:!1});(b=b[_.zd])&&a.f.set(_.zd,{dd:b.licenseUrl||"",customData:c,te:!1});if(0===a.f.size)throw new _.H(_.F,6,6E3);if((c=a.h.preferredDrmSystem)&&a.f.get(c))a.a=c;else if(a.f.get(_.xd))a.a=_.xd;else if(a.f.get(_.zd))a.a=_.zd;else throw new _.H(_.F,6,6001,"Configuration for the target system is missing.");yield UM(a);a.j=!0})}release(){const a=this;return _.x(function*(){a.j=!1;a.o=null;a.a=_.Ee;a.l=null;a.f=new Map})}getDrmInfo(){return this.o}},XM="DeleteLicenseAfterUse",
YM="LicenseServer",ZM="CustomData";var eO=class{constructor(a){this.m=a;this.a=this.m.a;this.f=_.Wn;this.j=_.At;this.w=(new Date).getTime();this.l=!1;this.o=-1;this.h=2;this.g=new _.R("clpp.tizen.StateManager")}initialize(){this.a.on(UN,this.C,this);this.a.on($N,this.B,this);this.a.on(aO,this.A,this);this.a.on(WN,this.H,this);this.a.on(XN,this.G,this);this.a.on(bO,this.F,this)}release(){bN(this,_.Wn);this.l=!1;this.o=-1;this.h=2}destroy(){this.release();this.a.off(UN,this.C);this.a.off($N,this.B);this.a.off(aO,this.A);this.a.off(WN,
this.H);this.a.off(XN,this.G);this.a.off(bO,this.F);this.m=this.a=null}C(){this.g.debug("Buffering start. Player state: ",this.a.getState());this.h=this.a.B?1:2;bN(this,_.Rn)}B(a){this.g.debug("Buffering progress: "+a.percent+" %. Player state: ",aN(this.f))}A(){this.g.debug("Buffering complete. Player state: ",this.a.getState());if(!this.l){this.l=!0;var a=this.m.getConfiguration().autoplay;const b=this.a.getState()===cO;if(!a&&b){bN(this,_.Yn);return}}if(a=this.f!==_.Xn)a=this.a.getState(),a=a===
cN||a===dN;a&&eN(this)}H(){this.g.debug("Preparing starts. AVPlay State: ",this.a.getState());this.a.getState()===dO?bN(this,_.Xn):this.g.error("AVPlay prepares while state is not IDLE")}G(){this.g.debug("Preparing ends: AVPlay state:",this.a.getState())}F(){bN(this,_.On)}getState(){return this.f}};var fO=class{constructor(){this.o=this.A=this.f=this.h=this.B=this.m=this.j=this.a=null;this.C=!1;this.w=!0;this.l=null;this.g=new _.R("clpp.tizen.TextStreamer")}initialize(a){this.m=a}load(a){const b=this;return _.x(function*(){if(b.m)if(b.B=a,b.j=yield fN(b),b.j){var c={configurationId:"",networkingEngine:b.m.getNetworkEngine(),filterNewPeriod:()=>{},filterAllPeriods:()=>{},onTimelineCueAdded:()=>{},onEvent:()=>{},onError:()=>{}};try{b.a=yield b.j.start(a.url,c)}catch(d){b.g.warn(d);try{b.a=yield b.j.start(a.url.replace("https://",
"http://"),c)}catch(e){b.g.error(e),b.a=null}}if(b.a&&gN(b.a)){b.h=hN(b);try{yield b.h.open();b.f=iN(b);const d=b.m.getConfiguration();b.f.h=d.streaming;b.o=d.preferredTextLanguage;b.A=d.preferredTextRole;b.C=d.preferForcedSubtitles}catch(d){b.g.debug("Could not setup media source..."),b.h=null,b.f=null,b.j=null,b.a=null}}}else b.g.debug("Could not find manifest parser for source. Make sure parsers are registered.");else b.g.debug("Text streamer is not initialized. Will not load()")})}G(a){this.g.debug(_.EA,
a);this.w=!0;let b=_.hD(a.textStreams,this.o||"",this.A||"",this.C)[0]||null;this.l&&(a.textStreams.includes(this.l)&&(b=this.l),this.l=null);return{variant:null,text:b}}F(){this.g.debug("canSwitch_");this.w=!1;this.l&&(_.QE(this.f,this.l,!0,0),this.l=null)}U(){this.g.debug("onError_")}H(){this.j&&this.j.update&&this.j.update()}start(){const a=this;return _.x(function*(){if(a.f)try{a.f.start()}catch(b){a.g.error("Error while starting streaming engine",b)}})}setTextVisibility(a){this.g.debug("Set text visibility",
a);this.h&&this.h.getTextDisplayer().setTextVisibility(a)}release(){const a=this;return _.x(function*(){a.m=null;a.a=null;a.B=null;a.A=null;a.o=null;a.w=!0;a.l=null})}destroy(){const a=this;return _.x(function*(){a.j&&(yield a.j.stop(),a.j=null);a.f&&(yield a.f.destroy(),a.f=null,a.w=!0);a.h&&(yield a.h.destroy(),a.h=null)})}};var W=class extends _.S{constructor(){super();this.h=this.a=this.m=null;this.f={};this.g=new _.R("clpp.tizen.TrackManager");this.w=this.l=this.j=null;this.B=!1;this.o=1}C(a){var b=a.eventid;a=a.data;switch(b){case gO:0<Object.keys(this.f).length||(this.g.debug("Loading track manager!"),this.load());b=webapis.avplay.getCurrentStreamInfo();0<b.length&&(b=+pN(this,b[0].extra_info).Bit_rate,b=qN(this,{bandwidth:b}))&&(this.w=b,oN(this,b));break;case hO:nN(this);break;default:this.g.debug("Event type: "+
b+" data: "+a)}}A(a){a.detail.currentState===_.Zn&&this.m.off(_.Nf,this.A)}initialize(a){this.m=a;this.a=this.m.a;this.m.on(_.Nf,b=>{this.B||(b=b.detail,b.currentState===_.Zn&&(this.g.debug("Current state",b.currentState),this.B=!0,rN(this)))});this.a.on(iO,this.C,this)}release(){this.f={};this.h=this.w=this.l=this.j=null;this.B=!1;this.o=1}load(){if(this.a&&!(0<Object.keys(this.f).length)){this.h=this.m.h;this.m.off(_.Nf,this.A);this.m.on(_.Nf,this.A,this);try{const a=FN(this.a);this.f=xN(this,a);
const b=this.f[_.L]||[];b.length&&(this.j=b[0].renditions[0]||null);nN(this)}catch(a){this.g.debug("Could not load track manager")}}}destroy(){this.a.off(iO,this.C);this.a=this.m=null}getVideoTracks(){return this.f[_.N]||[]}getAudioTracks(){return this.f[_.L]||[]}ka(){return this.f[_.K]||[]}oa(){return AN(this,_.N)}Qa(){return AN(this,_.L)}Ia(){return AN(this,_.K)}cb(){return this.w}ob(){this.g.info(NM);return null}pb(){this.g.info(NM);return null}Ja(){const a=this.oa();return a?a.track:null}na(){const a=
this.Qa();return a?a.track:null}ua(){const a=this.Ia();return a?a.track:null}jb(a){null===a?(a=this.oa(),HN(this.a,a.bandwidth,null).then(()=>{nN(this)})):0<a.renditions.length&&this.Ya(a.renditions[0])}wa(a){a?DN(this,a.renditions[0]):this.g.warn("Cannot disable audio tracks on this platform.","Consider muting audio instead...")}La(a){a?(a=a.renditions[0],this.h?mN(this.h,a.track):DN(this,a)):(this.g.debug("Disabling text tracks"),this.l=null,IN(this.a,!1),this.m.trigger(new _.E(_.Kk)))}Ya(a){const b=
this.oa();this.a.o||a.width!==b.width||a.height!==b.height||a.bandwidth!==b.bandwidth?(this.w=a,oN(this,a),HN(this.a,b.bandwidth,a.bandwidth).then(()=>{nN(this)}).catch(c=>{const d=new _.H(_.F,7,7200,{tizenerror:c});this.g.debug("Error while switching video track",c);this.m.onError(d)})):this.g.debug("Trying to switch to already active rendition. Doing nothing...")}hb(a){DN(this,a)}ib(a){this.h?mN(this.h,a.track):DN(this,a)}addTextTrack(){}ra(){return this.a.o}};W.prototype.isAbrEnabled=W.prototype.ra;
W.prototype.addTextTrack=W.prototype.addTextTrack;W.prototype.setTextRendition=W.prototype.ib;W.prototype.setAudioRendition=W.prototype.hb;W.prototype.setVideoRendition=W.prototype.Ya;W.prototype.setTextTrack=W.prototype.La;W.prototype.setAudioTrack=W.prototype.wa;W.prototype.setVideoTrack=W.prototype.jb;W.prototype.getTextTrack=W.prototype.ua;W.prototype.getAudioTrack=W.prototype.na;W.prototype.getVideoTrack=W.prototype.Ja;W.prototype.getLoadingTextRendition=W.prototype.pb;
W.prototype.getLoadingAudioRendition=W.prototype.ob;W.prototype.getLoadingVideoRendition=W.prototype.cb;W.prototype.getTextRendition=W.prototype.Ia;W.prototype.getAudioRendition=W.prototype.Qa;W.prototype.getVideoRendition=W.prototype.oa;W.prototype.getTextTracks=W.prototype.ka;W.prototype.getAudioTracks=W.prototype.getAudioTracks;W.prototype.getVideoTracks=W.prototype.getVideoTracks;var mO=class extends _.ft{constructor(a){super();this.m=a;this.h=null;this.g=new _.R("clpp.tizen.Middleware");this.C=1;this.B=!1;this.l=null;this.F=0;this.o=!0;this.f=!1;this.a=null;this.A=1;this.w=!1;this.j={}}I(){this.w=!0;this.f||this.trigger(new _.E(UN))}H(a){this.w=!0;this.trigger(new _.E($N,{percent:a}))}G(){this.w=!1;this.trigger(new _.E(aO))}L(){this.trigger(new _.E(bO))}K(a,b){this.trigger(new _.E(iO,{eventid:a,data:b}))}N(a,b,c,d,e){this.trigger(new _.E(jO,{duration:a,text:b,subtitleType:c,
attriCount:d,attributes:e}))}J(a,b){this.trigger(new _.E(kO,{drmType:a,drmData:b}));this.h&&(a=this.h,a.j&&(a.a===_.zd&&"Challenge"===b.name?WM(a,b):"DrmError"===b.name&&(a.g.debug("DrmError event",b),b=new _.H(_.F,6,6005,{message:JSON.stringify(b)}),a.D.onError(b))))}U(a){this.trigger(new _.E(lO,{eventType:a}))}play(){const a=this.getState(),b=()=>new Promise((c,d)=>{let e=null;const f=()=>{c();clearTimeout(e)};this.one(KN,f,this);e=setTimeout(()=>{this.off(KN,f);d("Timeout")},3E4)});if(a===dO)return(new Promise((c,
d)=>{webapis.avplay.prepareAsync(()=>{MN(this);c(webapis.avplay.play())},e=>{this.trigger(new _.E(lO));d(e)})})).then(()=>b());if(a===dN||a===cO)try{return webapis.avplay.play(),b()}catch(c){return Promise.reject(c)}return a===cN?Promise.resolve():Promise.reject("Player is in invalid state")}pause(){try{webapis.avplay.pause()}catch(a){Promise.reject(a)}return this.getState()===dN?Promise.resolve():Promise.reject()}setPlaybackRate(a){const b=this.getState();if(b===cO||b===cN||b===dN){try{webapis.avplay.setSpeed(a),
this.C=a}catch(c){return this.g.debug("Error while trying to set playback rate",c),this.setPlaybackRate(this.C)}return!0}this.g.debug("Cannot set playback rate; AVPlay is in inconsistent state: "+b);return!1}getPlaybackRate(){return this.C}load(a,b){const c=this;return _.x(function*(){c.g.debug("configure()",b||"");try{yield RN(c),yield YN(c,a,b)}catch(d){throw new _.H(_.F,7,7003,null,d);}})}getState(){if(this.f&&this.a)return this.a.We;try{return webapis.avplay.getState()}catch(a){this.U(JSON.stringify(a))}}seek(a){const b=
1E3*a;return new Promise((c,d)=>{this.B=!0;this.m.trigger(new _.E(_.gg));webapis.avplay.seekTo(b,()=>{this.B=!1;this.m.trigger(new _.E(_.fg));c()},()=>{this.B=!1;d()})})}getPosition(){if(this.f&&this.a)return this.a.position;try{return webapis.avplay.getCurrentTime()/1E3}catch(a){this.U(JSON.stringify(a))}}getDuration(){if(this.f&&this.a)return this.a.duration;try{return webapis.avplay.getDuration()/1E3}catch(a){this.U(JSON.stringify(a))}}release(){return new Promise((a,b)=>{try{this.h&&(this.h.release(),
this.h=null);webapis.avplay.stop();webapis.avplay.close();for(const c in this.j){const d=this.j[c];d&&d.Nd.stop()}this.j={};this.C=1;this.B=!1;this.a=this.l=null;return a()}catch(c){return b(c)}})}getVolume(){let a=null;try{a=tizen.tvaudiocontrol.getVolume()}catch(b){switch(b.name){case OM:this.g.debug("The application does not have the privilege to get the volume.",PM);break;default:this.g.debug(MM,b)}}return a}setVolume(a){try{tizen.tvaudiocontrol.setVolume(Math.max(0,Math.min(100*a,100)))}catch(b){switch(b.name){case "InvalidValueError":this.g.warn("Invalid value passed for setVolume.",
"The passed value value should be in the range of 0 to 1.");break;case OM:this.g.warn("The application does not have the privilege to set the volume.",PM);break;default:this.g.warn("An unknown error occurred while trying to set volume",b)}}}isLive(){if(this.f&&this.a)return this.a.isLive;try{return"1"===webapis.avplay.getStreamingProperty("IS_LIVE")}catch(a){this.U(JSON.stringify(a))}}stop(){try{webapis.avplay.stop()}catch(a){this.g.debug(a)}}getDrmInfo(){this.h&&this.h.getDrmInfo();return null}setSourceIndex(a){this.F=
a}getSourceIndex(){return this.F}getLoadedSource(){return this.l&&this.l[this.getSourceIndex()]}},dO="IDLE",cO="READY",cN="PLAYING",dN="PAUSED",sN=_.Sb,tN="AUDIO",CN="TEXT",hO="PLAYER_MSG_RESOLUTION_CHANGED",gO="PLAYER_MSG_BITRATE_CHANGE",$M="PLAYREADY",VM="WIDEVINE_CDM";var qO=class extends _.ft{constructor(){super();this.a=new mO(this);this.f=new eO(this);this.configuration=this.B=_.Uk();this.w=null;this.g=new _.R("clpp.tizen.Player");this.j=null;this.l=new W;this.C=new _.ap;this.o=this.h=null;this.A=!1}H(){this.g.debug("On Stream completed. Current time: ",this.getPosition());this.trigger(new _.E(_.Vd));this.configuration.loop?this.seek(this.configuration.startTime||0).catch(()=>{this.g.debug("Could not loop playback")}):this.a.stop()}F(a){this.trigger(new _.E(_.Xf,
{currentTime:a.currentTime/1E3}))}I(a){const b=this.a.getPosition(),c=b+a.duration/1E3;let d=a.text||"";this.g.debug("Got subtitles: ",d,"start:",b,"end:",c,a);(d=_.Bi(d))&&this.o.append([new _.Bs(b,c,d)],[])}G(a){this.g.debug("DRM event: "+a.drmType+", data: "+a.drmData)}J(){this.A||(this.g.debug("Initial buffering completed..."),this.A=!0)}U(a){this.g.debug(`Error: TYPE: ${a.eventType}`);bN(this.f,_.Vn);a=new _.H(_.F,7,7200,{tizenerror:a.eventType});this.a.release();this.trigger(new _.E(_.r,{detail:a}))}init(a,
b){this.configuration=this.B=b;this.w=a;this.a.on(bO,this.H,this);this.a.on(KN,this.F,this);this.a.on(jO,this.I,this);this.a.on(kO,this.G,this);this.a.on(lO,this.U,this);this.a.on(aO,this.J,this);this.f.initialize();this.l.initialize(this);this.g.debug("Initializing player surface");this.w.hideMediaElement();a=nO;nO+=1;a="__clpp_tizen_player_"+a;this.j=_.uo(_.Fe,{id:a,type:"application/avplayer"});this.w.addElementToContainer(this.j,!0);var c=this.w.getMedia();if(c){a=this.j;{b=[_.Cg,_.Zd,"position",
_.he,"top"];const e={};c=null!==c.parentElement?window.getComputedStyle(c,null):c.style;if(!b||0===b.length)for(d in b||(b=[]),c)b.push(d);for(const f of b)e[f]=c[f];var d=e}_.wo(a,d);ZN(this)}}getSurface(){return this.w}getConfiguration(){return this.configuration}getTimeline(){return null}setupPlaylist(){return Promise.reject(_.qb)}appendLoad(){return Promise.reject(_.qb)}seekWith(){return Promise.reject(_.qb)}destroy(){const a=this;return _.x(function*(){yield a.release();a.a.off(bO,a.H);a.a.off(KN,
a.F);a.a.off(jO,a.I);a.a.off(kO,a.G);a.a.off(lO,a.U);a.a.off(aO,a.J);a.h&&(yield a.h.destroy(),a.h=null);a.j&&(a.j.parentElement.removeChild(a.j),a.j=null);a.l.destroy();a.f.destroy();a.l=null;a.f=null})}namespace(){return oO}getPlaybackRate(){return this.a.getPlaybackRate()}setDrmCustomDataModifier(){}setCdnErrorCallback(){}detach(){}setPlaybackRate(a){this.a.setPlaybackRate(a)}getPosition(){return this.getMediaPosition()}getMediaPosition(){return 0<(this.configuration.startTime||0)&&!this.A?0:this.f.getState()===
_.On?this.getDuration():this.a.getPosition()||0}seek(a){return typeof a===_.t&&0<=a?(this.isLive()||(a=Math.min(a,this.getDuration())),this.a.seek(a)):Promise.reject()}getPresentationStartTime(){return null}getSeekRange(){return{start:0,end:0}}getVolume(){const a=this.a.getVolume();return typeof a===_.t?a/100:null}setVolume(a){this.a.setVolume(a)}getDuration(){return this.getMediaDuration()}getMediaDuration(){return this.a.getDuration()}getBufferInfo(){this.g.warn(_.qa);return new _.et}getTrackManager(){return this.l}unload(){return this.a.release().then(()=>
{this.l.release()})}release(){const a=this;return _.x(function*(){a.h&&(yield a.h.release());a.o&&(yield a.o.destroy(),a.o=null);yield a.a.release();a.l.release();a.f.release();a.A=!1})}load(a){const b=this;return _.x(function*(){b.configuration=_.Wk(b.B,a);var c=_.En(b.configuration,[_.be,"native"]);b.o=c.create(b);c=_.bo(b.configuration)[0];if(b.configuration.tizen&&b.configuration.tizen.sideStreamText){b.h=new fO;b.h.initialize(b);try{yield b.h.load(c),b.h.start()}catch(d){b.g.error(d)}}try{yield b.a.load(b.configuration)}catch(d){throw b.onError(d),
d;}b.l.load()})}play(){this.trigger(new _.E(_.Te));ZN(this);return this.a.play().then(()=>{eN(this.f)})}pause(){return this.a.pause().then(()=>{eN(this.f)})}getState(){return this.f.getState()}getPeriods(){return[]}onError(a){const b=new _.E(_.r,{detail:a});a.severity===_.F&&(bN(this.f,_.Vn),this.a.release());this.trigger(b);b.defaultPrevented&&(b.a=!0)}getDrmInfo(){return this.a.getDrmInfo()}isEnded(){return this.f.getState()===_.On}isPaused(){return this.a.getState()===dN}isMuted(){return PN(this.a)}setMuted(a){TN(this.a,
a)}getNetworkEngine(){return this.C}setNetworkEngine(a){this.C=a}isLive(){return this.a.isLive()}getStats(){return null}setSourceIndex(a){this.a.setSourceIndex(a)}getSourceIndex(){return this.a.getSourceIndex()}getLoadedSource(){return this.a.getLoadedSource()}canPlay(a,b){return(new pO).canPlay(a,b)}getTimelineCues(){return[]}getTextDisplayer(){return this.o}resetAbr(){}};qO.prototype.getTextDisplayer=qO.prototype.getTextDisplayer;qO.prototype.setNetworkEngine=qO.prototype.setNetworkEngine;
qO.prototype.getNetworkEngine=qO.prototype.getNetworkEngine;var oO="clpp.tizen",nO=0,pO=class{a(){return oO}canPlay(a){a=a.type;const b=!!window.webapis;if((a===_.zc||a===_.Ok||a===_.Ec)&&b){if(_.Xj(2))return 2;if(_.Xj(3)||_.Xj(4)||_.Xj(5)||_.Xj(6))return _.C("Use of clpp.tizen.TizenComponent is not recommended for Tizen version \x3e\x3d 3."),1}return 0}f(a){return a===_.na}create(){return new qO}};_.z("clpp.tizen.TizenComponent",class extends _.Yt{f(){_.mh(new pO)}a(){var a=oO;a&&_.kh[a]&&(delete _.kh[a],_.lh.info("Removed Player factory: '"+a+"'"))}id(){return"tizen"}});var UN="onbufferingstart",$N="onbufferingprogress",aO="onbufferingcomplete",bO="onstreamcompleted",KN="oncurrentplaytime",iO="onevent",jO="onsubtitlechange",kO="ondrmevent",lO="onerror",WN="preparingstart",XN="preparingend";};f.call(g, window);