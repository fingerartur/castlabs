import {clpp} from "./cl.core.js";let g={};const _ = clpp._;var f=function(window){'use strict';var wv="Registering listeners",xv="clpp.vimond.VimondPlugin",yv=function(a,b){a.m.trigger(new _.E(_.sg,{detail:b}))},zv=function(a,b,c){b&&(a.B=!0,a.h.stop());a.m.onError(new _.H(b?_.F:1,9,9201,c))},Av=function(a,b){const c=a.m.getState();if(1===b)return["str-start",_.df];if(a.h)return[_.Ud,_.Pe];if(c===_.On)return[_.Ud,null];if(c===_.Vn)return[_.r,_.Pe];b=_.Pe;if(c===_.Rn||c===_.Zn||a.f)b=_.df;return["period",b]},Bv=class{constructor(a,b,c,d,e){this.K=a;this.L=b;this.N=c;this.m=d;this.F=
e;this.a=new _.ts;this.l=!0;this.f=this.j=this.B=!1;this.C=null;this.h=new _.Tj(this.A.bind(this));this.g=new _.R("clpp.vimond.VimondDispatcher");this.o=this.w=0;this.m&&this.a&&(this.g.debug(wv),this.a.on(this.m,_.Nf,this.I.bind(this)),this.a.on(this.m,_.Xf,this.J.bind(this)),this.a.on(this.m,_.cc,this.G.bind(this)),this.a.on(this.m,_.dc,this.H.bind(this)))}J(){this.f||(this.f=1<Math.abs(this.w-this.m.getPosition()));this.w=this.m.getPosition()}G(){this.g.debug("Ad break started");this.j=!0}H(){this.g.debug("Ad break stopped");
this.j=!1}I(a){const b=this;return _.x(function*(){const c=a.detail,d=c.currentState;b.g.debug(`State changed, prev: ${c.previousState} curr: ${d}`);b.B||b.j||(d!==b.C||b.f?b.l&&d!==_.Zn||(b.f&&[_.Yn,_.Rn].includes(d)?b.g.debug("Seeking"):(b.f&&d===_.Zn&&(b.g.debug("Seeked"),b.f=!1),[_.Zn,_.Yn,_.Vn,_.On].includes(d)&&(b.C=d,yield b.A(),d===_.On&&b.h.stop()))):b.g.debug("Ignore transition"))})}A(){const a=this;return _.x(function*(){{const n=Math.floor(Date.now()/1E3);0<a.o&&a.g.debug(`Last event was ${n-
a.o} seconds ago`);a.o=n}a.h.stop();a.h.ha(a.l?10:a.K);a.l=!1;try{{var b=a.F;b.f++;const q=_.Pg(b.o);q.client.buildName=_.ra;q.client.buildVersion=_.fa;var c=q.client;{const B=b.a.m.getDrmInfo();var d=B?B.keySystem:""}c.drm=d;q.client.pageUrl=document.location.href;q.client.streamUrl=b.a.m.getLoadedSource().url;q.client.userAgent=navigator.userAgent;q.client.videoFormat=b.a.m.getLoadedSource().type||"";var e=q.client;{const B=b.a.m.getLoadedSource();var f=((new _.Kl(B.url)).scheme||"").replace(":",
"")}e.videoProtocol=f;const u=Av(b.a,b.f);q.client.playerEvent=u[0]||"";q.client.playerState=u[1]||"";q.progress.vod&&(q.progress.vod.position=b.a.getPosition());const v=q.progress.live;if(v){{var g=b.a;const B=g.m.getPresentationStartTime()||0,D=Math.floor(B+g.m.getPosition());var h=(new Date(1E3*D)).toISOString()}v.position=h;{var k=b.a;const B=k.m.getPosition(),D=k.m.getSeekRange().end;var l=30>Math.abs(D-B)}v.onLiveEdge=l;typeof v.liveResumePossible!==_.Pc&&(v.liveResumePossible=!0)}q.progress.eventNumber=
b.f;q.timestamp=(new Date).toISOString();b.g.debug("Fire an event");const y=_.Si(b.l);y.method=_.ub;y.contentType="application/json";y.headers.Authorization=`Bearer ${b.h}`;y.body=_.ui(JSON.stringify(q));var m=b.j.fetch(y).R}const n=yield m;yv(a,n)}catch(n){m=n.code,b=n.data,[1002,1003].includes(m)?(a.g.debug("Unreachable service"),yv(a,b),zv(a,a.L,b)):1001===m?(a.g.debug("Generic service error"),yv(a,b),zv(a,a.N,b)):a.g.error(n.toString())}})}dispose(){this.g.debug(_.Pb);_.ph(this.a);this.h.stop()}};var Cv=class{constructor(a,b,c,d,e){this.l=a;this.o=c;this.h=b;this.a=d;this.j=e;this.g=new _.R("clpp.vimond.VimondService");this.f=0}Me(a){this.h=a}};var Dv=class{constructor(a){this.m=a;this.a=new _.ts;this.g=new _.R("clpp.vimond.VimondAdapter");this.f=this.h=!1;this.m&&this.a&&(this.g.debug(wv),this.a.on(this.m,_.vf,this.o.bind(this)),this.a.on(this.m,_.cc,this.j.bind(this)),this.a.on(this.m,_.dc,this.l.bind(this)))}getPosition(){return Math.floor(this.m.getPosition())}o(){this.h=!0}j(){this.f=!0}l(){this.f=!1}dispose(){this.g.debug(_.Pb);_.ph(this.a)}};var Ev=class extends _.Au{constructor(){super();this.a=!1;this.g=new _.R(xv);this.j=this.h=this.f=null}onPlayerCreated(){}onContentWillLoad(a){var b=a.getConfiguration();(this.a=!_.A(b.vimond)&&typeof b.vimond===_.Fe)?a.namespace()===_.kd&&(this.a=!1,this.g.info("Vimond does not report when casting.")):this.g.warn("Vimond plugin is loaded but not configured. Will do nothing.");if(this.a){b=a.getConfiguration().vimond;for(var c of["authToken","playerEventRequest"])if(!b[c]){this.g.warn(`${c} key is missing`);
a.onError(new _.H(1,9,9200));return}this.g.debug(_.sa);c=b.failIfUnreachable;typeof c!==_.Pc&&(c=!0);var d=b.failOnError;typeof d!==_.Pc&&(d=!0);this.f=new Dv(a);this.h=new Cv(b.playerEventRequest.uri,b.authToken,b.playerEventRequest.body,this.f,a.getNetworkEngine());this.j=new Bv(b.playerEventRequest.eventInterval,c,d,a,this.h)}}onPlayerWillRelease(){this.a&&(this.f&&this.f.dispose(),this.j&&this.j.dispose(),this.j=this.h=this.f=null)}onPlayerWillDestroy(){}id(){return"vimond"}Me(a){this.a&&this.h&&
this.h.Me(a)}};_.z(xv,Ev);Ev.prototype.updateAuthToken=Ev.prototype.Me;Ev.Id="vimond";_.dp(new class{create(){return new Ev}});};f.call(g, window);