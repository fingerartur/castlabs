import {clpp} from "./cl.core.js";let g={};const _ = clpp._;var f=function(window){'use strict';var zS="Ad Error",AS="onAdBreakStarted()",BS="onAdBreakStopped()",CS=function(a){var b=_.vk();let c=Conviva.Constants.DeviceType.DESKTOP,d=Conviva.Constants.DeviceCategory.WEB;const e=b.os;b=b.osVersion.name;let f="";_.hk()&&(f="Apple");_.gk()?(f="Google",c=Conviva.Constants.DeviceType.SETTOP,d=Conviva.Constants.DeviceCategory.CHROMECAST):_.ik()?(c=Conviva.Constants.DeviceType.MOBILE,/(android)/i.test(navigator.userAgent)?d=Conviva.Constants.DeviceCategory.ANDROID_DEVICE:_.hk()&&(d=Conviva.Constants.DeviceCategory.APPLE_DEVICE)):
_.ak()||_.Xj()||_.Wj("Hisense")?(c=Conviva.Constants.DeviceType.SMARTTV,d=Conviva.Constants.DeviceCategory.SMART_TV,_.ak()?(b="",f="LG",d=Conviva.Constants.DeviceCategory.LG_TV):_.Xj()?(f="Samsung",d=Conviva.Constants.DeviceCategory.SAMSUNG_TV):_.Wj("Hisense")&&(b="",f="Hisense")):_.Wj("Xbox One")&&(f="Microsoft",c=Conviva.Constants.DeviceType.CONSOLE,d=Conviva.Constants.DeviceCategory.XBOX);const g=a.deviceMetadata||{},h=(k,l)=>{k in g||!l||(g[k]=l)};h(Conviva.Constants.DeviceMetadata.TYPE,a.deviceType||
c);h(Conviva.Constants.DeviceMetadata.OS_NAME,e);h(Conviva.Constants.DeviceMetadata.OS_VERSION,b);h(Conviva.Constants.DeviceMetadata.CATEGORY,a.deviceCategory||d);h(Conviva.Constants.DeviceMetadata.BRAND,a.deviceBrand||f);return g},DS=function(a){return a?Conviva.Constants.StreamType.LIVE:Conviva.Constants.StreamType.VOD},ES=function(a){return 0===a?"Pre-roll":-1===a?"Post-roll":"Mid-roll"},GS=function(a,b,c,d){const e={};e[Conviva.Constants.PLAYER_NAME]=c;e[Conviva.Constants.VIEWER_ID]=b;e[Conviva.Constants.IS_LIVE]=
DS(!!d);e[Conviva.Constants.ASSET_NAME]=zS;a&&(e[Conviva.Constants.ASSET_NAME]=a.getTitle(),e[Conviva.Constants.STREAM_URL]=a.getMediaUrl(),e[Conviva.Constants.DURATION]=a.getDuration(),e["c3.ad.id"]=FS(a.getId()),e["c3.ad.creativeId"]=FS(a.getCreativeId()),e["c3.ad.system"]=FS(a.getAdSystem()),e["c3.ad.mediaFileApiFramework"]=FS(a.getApiFramework()),e["c3.ad.advertiser"]=FS(a.getAdvertiserName()),e["c3.ad.position"]=ES(a.getPodIndex()),e["c3.ad.technology"]=0===a.Fb()?Conviva.Constants.AdType.CLIENT_SIDE:
Conviva.Constants.AdType.SERVER_SIDE,e["c3.ad.adManagerName"]=FS(a.yb()),e["c3.ad.adManagerVersion"]=FS(a.zb()),e["c3.ad.advertiserCategory"]=FS(null),e["c3.ad.advertiserId"]=FS(null),e["c3.ad.breakId"]=FS(null),e["c3.ad.campaignName"]=FS(null),e["c3.ad.category"]=FS(null),e["c3.ad.classification"]=FS(null),e["c3.ad.creativeName"]=FS(null),e["c3.ad.sequence"]=FS(a.Sb()),e["c3.ad.sessionStartEvent"]=FS(null),e["c3.ad.unitName"]=FS(null),e["c3.ad.dayPart"]=FS(null),b=a.getWrapperAdIds().slice(-1)[0]||
a.getId(),c=a.getWrapperAdSystems().slice(-1)[0]||a.getAdSystem(),a=a.getWrapperCreativeIds().slice(-1)[0]||a.getCreativeId(),e["c3.ad.firstAdId"]=FS(b),e["c3.ad.firstAdSystem"]=FS(c),e["c3.ad.firstCreativeId"]=FS(a));return e},FS=function(a){return a?""+a:"NA"},KS=function(a){a.f.on(a.m,_.cc,a.C.bind(a));a.f.on(a.m,_.dc,a.F.bind(a));a.f.on(a.m,_.qc,a.L.bind(a));a.f.on(a.m,_.nc,a.l.bind(a));a.f.on(a.m,_.mc,a.l.bind(a));a.f.on(a.m,_.oc,a.l.bind(a));a.f.on(a.m,_.ec,a.l.bind(a));a.f.on(a.m,_.rc,a.N.bind(a));
a.f.on(a.m,_.pc,a.K.bind(a));a.f.on(a.m,_.fc,a.G.bind(a));a.f.on(a.m,_.ic,a.I.bind(a));a.f.on(a.m,_.jc,a.J.bind(a));a.f.on(a.m,_.hc,a.H.bind(a));a.f.on(a.m,_.lc,a.T.bind(a));a.f.on(a.m,_.sc,a.O.bind(a));a.f.on(a.m,_.r,b=>{var c=b.detail;if(10003===c.code&&(a.g.debug("onAdError()"),!a.h)){b=Conviva.Constants.ErrorSeverity;switch(c.data.errorType){case 0:c="Ad Load Error";break;case 1:c="Ad Play Error";break;default:c=zS}null===a.a&&HS(a,null);a.a.reportAdError(c,b.FATAL);a.h=!0;a.g.debug("Ad Playback Failure");
IS(a,JS,c)}})},IS=function(a,b,c=zS){if(a.a){a.a.reportAdMetric(Conviva.Constants.Playback.PLAYER_STATE,Conviva.Constants.PlayerState.STOPPED);switch(b){case JS:a.a.reportAdFailed(c,GS(null,a.B,a.A));break;case LS:a.a.reportAdSkipped();break;default:a.a.reportAdEnded()}a.a.release();a.a=null;a.j=!1}},HS=function(a,b){if(!a.o){a.h=!1;try{if(a.a=Conviva.Analytics.buildAdAnalytics(a.S()),b){const c=GS(b,a.B,a.A,a.m.isLive()),d=String(b.zb()),e={};e[Conviva.Constants.FRAMEWORK_NAME]=b.yb();e[Conviva.Constants.FRAMEWORK_VERSION]=
d;a.a.setAdPlayerInfo(e);a.a.reportAdStarted(c)}}catch(c){a.g.error("Could not create ad analytics session",c)}}},MS=function(a,b){const c={};c[Conviva.Constants.LOG_LEVEL]=Conviva.Constants.LogLevel.DEBUG;b.serviceUrl&&(a.g.warn("Touchstone URL is set. Do not set this in production!"),c[Conviva.Constants.GATEWAY_URL]=b.serviceUrl.replace(/\/$/,""));Conviva.Analytics.init(b.customerKey,null,c);Conviva.Analytics.setDeviceMetadata(CS(b));b.connectionType&&Conviva.Analytics.reportDeviceMetric(Conviva.Constants.Network.CONNECTION_TYPE,
b.connectionType);a.a=Conviva.Analytics.buildVideoAnalytics();a.o=!1;b={};b[Conviva.Constants.FRAMEWORK_NAME]=_.ra;b[Conviva.Constants.FRAMEWORK_VERSION]=_.fa;a.a.setPlayerInfo(b)},NS=function(a){return a.m.getConfiguration().autoplay||!1},PS=function(a){if(!a.l)if(a.C)a.g.warn("Current session still active. No-op.");else{var b=a.m.getLoadedSource()||a.K,c=a.m.getConfiguration().conviva||null,d=c&&c.viewerId||"N/A",e=c&&c.defaultResource||"N/A";a.g.debug(a.m.getConfiguration().source);var f={},g=
new _.Kl(b.url);b&&(f[Conviva.Constants.ASSET_NAME]=b.name||"N/A",f[Conviva.Constants.STREAM_URL]=_.jj(g));f[Conviva.Constants.PLAYER_NAME]=c.playerName||_.ra;f[Conviva.Constants.VIEWER_ID]=d;f[Conviva.Constants.DEFAULT_RESOURCE]=e;if(c&&!_.A(c.customTags))for(const h in c.customTags)f[h]=c.customTags[h];a.a.reportPlaybackRequested(f);a.a.setCallback(()=>{a.g.debug("reportMiscellaneousMetrics()");if(OS(a)){var h=1E3*a.m.getPosition();a.a.reportPlaybackMetric(Conviva.Constants.Playback.PLAY_HEAD_TIME,
h);if(h=a.m.getStats()){h=h.decodedFrames;const k=h-a.H;a.H=h;isFinite(k)&&(a.g.debug("Current FPS",k),a.a.reportPlaybackMetric(Conviva.Constants.Playback.RENDERED_FRAMERATE,k))}}});a.C=!0;a.h=!0;a.I=!1;0<a.j.length&&(a.g.debug("Report deferred events"),a.j.forEach(h=>{h.hf(h.args)}));a.j=[]}},QS=function(a){if(!a.l&&a.a){const b=DS(a.m.isLive()),c={};c[Conviva.Constants.IS_LIVE]=b;c[Conviva.Constants.DURATION]=a.m.getDuration();a.a.setContentInfo(c)}},OS=function(a){return null!==a.a&&a.C},RS=function(a){a.g.debug("terminateSession()");
a.a&&(a.a.reportPlaybackMetric(Conviva.Constants.Playback.PLAYER_STATE,Conviva.Constants.PlayerState.STOPPED),a.a.reportPlaybackEnded(),a.a.release(),Conviva.Analytics.release(),a.o=!0,a.C=!1,a.A=!1,a.h=!1,a.w=null,a.B=!1,a.O=0,a.J=!1,a.j=[],a.H=0)},SS=function(a,b){var c=b.getConfiguration();a.a=!_.A(c.conviva)&&typeof c.conviva===_.Fe;a.a?"undefined"===typeof window.Conviva?(a.g.warn("Conviva SDK is not loaded. Will do nothing."),a.a=!1,c=new _.H(1,9,9E3),a.U(b,c)):b.namespace()===_.kd&&(a.a=!1,
a.g.debug("Conviva does not report when casting.")):a.g.warn("Conviva plugin is loaded but not configured. Will do nothing.")},TS=function(a){const b=[];typeof a===_.Fe&&(a.customerKey||b.push("customerKey"),a.viewerId||b.push("viewerId"));if(0<b.length)throw new _.H(1,9,9001,{missingKeys:b});};var VS=class{constructor(a,b){this.m=a;this.S=b;this.B="";this.A=_.ra;this.g=new _.R("clpp.conviva.ad");this.f=new _.ts;this.a=null;this.h=this.o=this.w=this.j=!1}initialize(a){this.g.debug("Initialize Ad Insights");this.h=this.w=!1;this.B=a.viewerId;this.A=a.playerName||_.ra;KS(this)}release(){this.g.debug("Release Ad Insights");this.w?this.g.debug(_.ja):(_.ph(this.f),this.a&&IS(this,US),this.f.release(),this.w=!0,this.j=this.h=!1)}destroy(){this.g.debug(_.Ed);this.o?this.g.debug(_.ia):this.o=!0}C(){this.g.debug(AS)}F(){this.g.debug(BS)}L(a){this.g.debug("onAdStarted()");
a=a.ad;this.j||(this.g.warn("Ad load event was not triggered. This will have incidence on VSF"),HS(this,a));this.j=!1;this.a.reportAdMetric(Conviva.Constants.Playback.PLAYER_STATE,Conviva.Constants.PlayerState.PLAYING);this.a.reportAdMetric(Conviva.Constants.Playback.RESOLUTION,a.Cb(),a.Bb());this.a.reportAdMetric(Conviva.Constants.Playback.BITRATE,a.qb())}l(a){this.g.debug("onAdStateChanged()");if(this.a){const b=c=>{this.a.reportAdMetric(Conviva.Constants.Playback.PLAYER_STATE,c)};switch(a.type){case _.nc:case _.oc:b(Conviva.Constants.PlayerState.PLAYING);
break;case _.mc:b(Conviva.Constants.PlayerState.PAUSED);break;case _.ec:b(Conviva.Constants.PlayerState.BUFFERING)}}}N(){this.g.debug("onAdStopped()");this.a&&!this.h&&IS(this,US)}K(){this.g.debug("onAdSkipped()");this.a&&IS(this,LS)}G(){this.g.debug("onAdClicked()");this.a&&this.a.reportAdPlayerEvent("AdClicked")}I(){this.g.debug("onAdImpression()");if(this.a){const a=Conviva.Constants.Events;this.a.reportAdPlayerEvent(a.AD_IMPRESSION_START);this.a.reportAdPlayerEvent(a.AD_IMPRESSION_END)}}J(a){this.g.debug("onAdLoaded()");
const b=a.ad,c=()=>{this.j=!0;HS(this,b)};if(-1!==b.getPodIndex()||this.m.getPosition()>=this.m.getDuration()-5)c();else this.f.on(this.m,_.Xf,()=>{this.m.getPosition()>=this.m.getDuration()-5&&(this.f.off(this.m,_.Xf),c())})}H(){this.g.debug("onAdFirstQuartile()");this.a&&this.a.reportAdPlayerEvent(Conviva.Constants.Events.AD_FIRST_QUARTILE)}T(){this.g.debug("onAdMidPoint()");this.a&&this.a.reportAdPlayerEvent(Conviva.Constants.Events.AD_MID_QUARTILE)}O(){this.g.debug("onAdThirdQuartile()");this.a&&
this.a.reportAdPlayerEvent(Conviva.Constants.Events.AD_THIRD_QUARTILE)}},LS=0,US=1,JS=2;var WS=class{constructor(a,b){this.m=a;this.f=new _.ts;this.a=null;this.o=!1;this.G=!0;this.B=this.h=this.A=this.C=this.l=!1;this.O=0;this.J=!1;this.w=null;this.I=!1;this.g=b;this.K=this.F=null;this.j=[];this.H=0}initialize(a,b,c){this.l||(this.g.debug("Initialize conviva"),this.G=!1,this.F=_.Qg(b),this.K=c,this.m=a,MS(this,this.F),this.f.on(this.m,_.Te,this.ea.bind(this)),this.f.on(this.m,_.Nf,this.Z.bind(this)),this.f.on(this.m,_.Nc,this.L.bind(this)),this.f.on(this.m,_.gg,this.X.bind(this)),this.f.on(this.m,
_.fg,this.W.bind(this)),this.f.on(this.m,_.cc,this.S.bind(this)),this.f.on(this.m,_.dc,this.T.bind(this)),this.f.on(this.m,_.uc,this.aa.bind(this)),this.f.on(this.m,_.Mc,this.ga.bind(this)),this.f.on(this.m,_.r,this.N.bind(this)),NS(this)&&(this.g.debug("Start a new session: A new video starts in autoplay."),PS(this)))}release(){this.g.debug("Release conviva");this.G?this.g.debug(_.ja):(_.ph(this.f),OS(this)||this.o||!NS(this)||this.a&&this.a.reportPlaybackFailed("Exit Before Video Start"),OS(this)&&
RS(this),this.a=null,this.G=!0)}destroy(){this.g.debug(_.Ed);this.l?this.g.debug(_.ia):this.l=!0}reportAppEvent(a,b){let c=!1;try{Conviva.Analytics.reportAppEvent(a,b),c=!0}catch(d){this.g.debug("Report app event error",d),c=!1}return c}ea(){this.g.debug("onPlayRequest()");OS(this)||NS(this)?OS(this)&&this.A&&!this.h&&(this.g.debug("Resuming VST monitoring ..."),OS(this)&&!this.h&&(this.a.reportPlaybackEvent(Conviva.Constants.Events.USER_WAIT_ENDED),this.h=!0),this.A=!1):(this.g.debug("Creating conviva session. On Play Requested / No autoplay"),
PS(this))}Z(a){this.g.debug(_.Ke);const b=c=>{if(this.o&&(this.g.debug("Creating conviva session (On Seek / Replay)"),MS(this,this.F),PS(this),QS(this),OS(this))){var d=this.m.getTrackManager();d=d.oa()||d.cb();d.width&&d.height&&this.a.reportPlaybackMetric(Conviva.Constants.Playback.RESOLUTION,d.width,d.height);d.bandwidth&&this.a.reportPlaybackMetric(Conviva.Constants.Playback.BITRATE,d.bandwidth/1E3)}OS(this)&&this.a.reportPlaybackMetric(Conviva.Constants.Playback.PLAYER_STATE,c)};switch(a.detail.currentState){case _.Zn:b(Conviva.Constants.PlayerState.PLAYING);
break;case _.Yn:b(Conviva.Constants.PlayerState.PAUSED);break;case _.Rn:b(Conviva.Constants.PlayerState.BUFFERING);break;case _.On:this.g.debug("onVideoEnded()"),OS(this)&&(this.w&&this.w.sb()?(this.g.debug("Waiting for postroll Ad before terminating session"),this.J=!0):RS(this))}}L(a){this.g.debug(_.Ge);if(OS(this)){if(a=a.detail,typeof a.width===_.t&&typeof a.height===_.t&&this.a.reportPlaybackMetric(Conviva.Constants.Playback.RESOLUTION,a.width,a.height),a.bandwidth&&this.a.reportPlaybackMetric(Conviva.Constants.Playback.BITRATE,
a.bandwidth/1E3),(a=a.rendition)&&a.track&&(a=a.track)&&a.frameRate){const b={};b[Conviva.Constants.ENCODED_FRAMERATE]=a.frameRate;this.a.setContentInfo(b)}}else this.j.push({hf:this.L.bind(this),args:a})}X(){this.g.debug("onSeeking()");OS(this)&&this.a.reportPlaybackMetric(Conviva.Constants.Playback.SEEK_STARTED)}W(){this.g.debug("onSeeked()");OS(this)&&this.a.reportPlaybackMetric(Conviva.Constants.Playback.SEEK_ENDED)}aa(a){this.g.debug("onAdsTimelineChanged()");if(a=a.adsTimeline)this.w=a}S(a){this.g.debug(AS);
var b=a.ad;a=0===b.eb();const c=ES(b.getPodIndex());OS(this)||NS(this)||!a||PS(this);if(OS(this)){a=0===b.Fb()?Conviva.Constants.AdType.CLIENT_SIDE:Conviva.Constants.AdType.SERVER_SIDE;let d=0;const e={};1===b.Eb()&&(d=b.getDuration());e[Conviva.Constants.POD_DURATION]=d;e[Conviva.Constants.POD_INDEX]=++this.O;e[Conviva.Constants.POD_POSITION]=c;b=Conviva.Constants.AdPlayer;b=a!==Conviva.Constants.AdType.CLIENT_SIDE||_.gk()?b.CONTENT:b.SEPARATE;this.a.reportAdBreakStarted(a,b,e);this.B=!0}else this.g.debug("Bug: should already have a valid session")}T(){this.g.debug(BS);
OS(this)&&this.B&&(this.a.reportAdBreakEnded(),this.B=!1,this.J&&RS(this))}N(a){this.g.debug(_.He);if(this.o&&this.I)this.g.debug("Session ended in VPF; ignoring subsequent errors");else{var b=a.detail||null,c=b&&b.message||"Player error",d=Conviva.Constants.ErrorSeverity.WARNING;b&&b.severity&&b.severity===_.F&&(d=Conviva.Constants.ErrorSeverity.FATAL,OS(this)||PS(this));OS(this)?(this.g.debug("Report error",c,d),this.a.reportPlaybackError(c,d),d===Conviva.Constants.ErrorSeverity.FATAL&&(this.g.debug("Video Playback Failure"),
this.I=!0,RS(this))):this.j.push({hf:this.N.bind(this),args:a})}}ga(){this.g.debug("onAutoPlayBlocked()");OS(this)&&(this.g.debug("Auto-play blocked. Pausing VST monitoring."),this.A=!0,OS(this)&&this.h&&(this.a.reportPlaybackEvent(Conviva.Constants.Events.USER_WAIT_STARTED),this.h=!1))}};var XS=class{constructor(){this.h=this.f=null;this.a=!1;this.g=new _.R("clpp.conviva")}onPlayerCreated(a){this.f=new WS(a,this.g)}onContentWillLoad(a,b){SS(this,a);if(this.a){var c=a.getConfiguration();c=_.Qg(c.conviva||{});try{TS(c);const d=c.enableAdInsights||!1;this.f.initialize(a,c,b);d&&(this.h=new VS(a,()=>this.f.a),this.h.initialize(c))}catch(d){d instanceof _.H?this.U(a,d):this.U(a,new _.H(1,9,9002,d,d))}}}onContentLoaded(){this.a&&QS(this.f)}onPlayerWillDestroy(){this.a&&(this.a=!1,this.f.destroy(),
this.f=null,this.h&&(this.h.destroy(),this.h=null))}onPlayerWillRelease(){this.a&&(this.f.release(),this.h&&this.h.release())}id(){return"conviva"}U(a,b){a.trigger(new _.E(_.r,{detail:b}))}reportAppEvent(a,b){return this.f?this.f.reportAppEvent(a,b):!1}};_.z("clpp.conviva.ConvivaPlugin",XS);XS.prototype.reportAppEvent=XS.prototype.reportAppEvent;XS.Id="conviva";_.dp(new class{create(){return new XS}});};f.call(g, window);