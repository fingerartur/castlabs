import {clpp} from "./cl.core.js";let g={};const _ = clpp._;var f=function(window){'use strict';var Sx="apiUrl config is missing",Tx=function(a,b){a.j=a.j.filter(c=>c!==b)},Ux=function(a){let b=0>a;a=Math.abs(a);let c=a>>>0;a=Math.floor((a-c)/4294967296);a>>>=0;b&&(a=~a>>>0,c=(~c>>>0)+1,4294967295<c&&(c=0,a++,4294967295<a&&(a=0)));return[c,a]},Zx=function(a,b,c,d){if(!(null===c||void 0===c||typeof c===_.t&&0===c||typeof c===_.Qf&&0===c.length||Array.isArray(c)&&0===c.length))if(Array.isArray(c)){Vx(a,b<<3|2);b=new Wx;for(let e=0;e<c.length;e++)d(b,c[e]);Xx(a,b.length());Yx(a,b.end())}else Vx(a,
b<<3|0),d(a,c)},Xx=function(a,b){if(0<=b)Vx(a,b);else{for(let c=0;9>c;c++)a.a.push(b&127|128),b>>=7;a.a.push(1)}},$x=function(a,b,c){Zx(a,b,c,(d,e)=>{Xx(d,e)})},Vx=function(a,b){for(;127<b;)a.a.push(b&127|128),b>>>=7;a.a.push(b)},by=function(a,b,c){Zx(a,b,c,(d,e)=>{if(0<=e){{const [f,g]=Ux(e);ay(d,f,g)}}else{{const [f,g]=Ux(e);ay(d,f,g)}}})},cy=function(a,b,c,d){if(!(null===c||void 0===c||typeof c===_.t&&0===c||typeof c===_.Qf&&0===c.length||Array.isArray(c)&&0===c.length))if(Array.isArray(c))for(let e=
0;e<c.length;e++){Vx(a,b<<3|2);const f=new Wx;d(f,c[e]);Xx(a,f.length());Yx(a,f.end())}else Vx(a,b<<3|2),b=new Wx,d(b,c),Xx(a,b.length()),Yx(a,b.end())},dy=function(a,b,c){cy(a,b,c,(d,e)=>{for(let f=0;f<e.length;f++){let g=e.charCodeAt(f);if(128>g)d.a.push(g);else if(2048>g)d.a.push(g>>6|192),d.a.push(g&63|128);else if(65536>g)if(55296<=g&&56319>=g&&f+1<e.length){let h=e.charCodeAt(f+1);56320<=h&&57343>=h&&(g=1024*(g-55296)+h-56320+65536,d.a.push(g>>18|240),d.a.push(g>>12&63|128),d.a.push(g>>6&63|
128),d.a.push(g&63|128),f++)}else d.a.push(g>>12|224),d.a.push(g>>6&63|128),d.a.push(g&63|128)}})},Yx=function(a,b){a.a.push.apply(a.a,b)},ey=function(a,b,c){cy(a,b,c,(d,e)=>{Yx(d,e.a())})},fy=function(a,b,c){cy(a,b,c,(d,e)=>{Yx(d,e)})},ay=function(a,b,c){for(;0<c||127<b;)a.a.push(b&127|128),b=(b>>>7|c<<25)>>>0,c>>>=7;a.a.push(b)},hy=function(a){const b=new gy;b.h=Math.floor(a/1E3);b.f=a%1E3*1E6;return b},ly=function(a){return _.x(function*(){if(!a.j&&!a.f){0===a.a.length&&iy(a,new jy);var b=()=>
{};a.f=new Promise(c=>{b=c});try{const c=new ky;c.f=a.o;c.events.push(...a.a);const d=[...a.a],e=yield fetch(a.l,{method:_.ub,headers:{"Content-Type":"application/proto"},body:new Uint8Array(c.a())});if(e.ok)a.a=a.a.filter(f=>!d.includes(f));else throw Error("An error occurred while sending telemetry events to the API, "+`status='${e.status}' statusText='${e.statusText}'`);}finally{b(),a.f=null}}})},oy=function(a,b,c,d,e,f,g){const h=new my;h.headers=[new ny("CL-BROWSER-NAME",b),new ny("CL-BROWSER-VERSION",
c),new ny("CL-OS-FAMILY",d),new ny("CL-OS-VERSION",e),new ny("CL-SDK-NAME",f),new ny("CL-SDK-NAME",f),new ny("CL-SDK-VERSION",g)];iy(a,h)},iy=function(a,b){if(!a.j){var c=new py(a.w);c.sessionId=a.A;{var d=Date.now();const e=new qy;e.h=Math.floor(d/1E3);e.f=d%1E3*1E6;d=e}c.time=d;c.h=b.getId();c.f=new Uint8Array(b.a());a.a.push(c)}},ry=function(a){_.x(function*(){a.g.info("Destroy the session and stop sending events.");_.ph(a.f);a.a=!1;const b=a.m.getNetworkEngine();b.ye(a.o);b.gd(a.j);Tx(b,a.j);
a.h&&(yield a.h.dispose(),a.h=null)})},zy=function(a){switch(a){case _.Wn:return sy;case _.Xn:return ty;case _.Rn:return uy;case _.Zn:return vy;case _.Yn:return wy;case _.On:return xy;case _.Vn:return yy;default:return null}},Ay=function(a,b){a.g.debug("Sending event",b);iy(a.h,b)},Iy=function(a,b){switch(a){case 1:return By;case 2:return b===_.w?Cy:b===_.p?Dy:b===_.G?Ey:b===_.de?Fy:Gy;case 3:return Hy;default:return Gy}};var Wx=class{constructor(){this.a=[]}length(){return this.a.length}end(){const a=this.a;this.a=[];return a}};var Jy=class{constructor(a,b,c,d){this.downloadId=a;this.h=b;this.duration=c;this.j=d;this.f=[]}a(){const a=new Wx;ey(a,1,this.downloadId);$x(a,2,this.h);ey(a,3,this.duration);$x(a,4,this.j);ey(a,5,this.f);return a.end()}getId(){return 4}};var Ky=class{constructor(a,b){this.f=a;this.url=b;this.downloadId=null;this.headers=[];this.size=this.duration=null}a(){const a=new Wx;$x(a,1,this.f);ey(a,2,this.downloadId);dy(a,3,this.url);ey(a,4,this.headers);dy(a,5,null);ey(a,6,null);ey(a,7,this.duration);by(a,8,this.size);return a.end()}getId(){return 2}};var Ly=class{constructor(a,b){this.h=a;this.f=b}a(){const a=new Wx;$x(a,1,this.h);fy(a,2,this.f);return a.end()}};var My=class{constructor(a){this.cause=a;this.f=this.message=this.severity=this.errorCode=null}a(){const a=new Wx;$x(a,1,this.errorCode);$x(a,2,this.severity);dy(a,3,this.message);dy(a,4,this.f);ey(a,5,this.cause);return a.end()}getId(){return 7}};var ny=class{constructor(a,b){this.key=a;this.value=b}a(){const a=new Wx;dy(a,1,this.key);dy(a,2,this.value);return a.end()}};var Ny=class{constructor(){this.cause=this.severity=this.code=null}a(){const a=new Wx;$x(a,1,this.code);$x(a,2,this.severity);ey(a,3,this.cause);return a.end()}getId(){return 12}};var Oy=class{constructor(){this.data=null}a(){const a=new Wx;fy(a,1,this.data);return a.end()}};var Py=class extends Oy{constructor(){super();var a=new Uint8Array(16);crypto.getRandomValues(a);a[6]=a[6]&15|64;a[8]=a[8]&63|128;this.data=a}toString(){const a=[];for(let b=0;256>b;++b)a.push((b+256).toString(16).slice(1));return a[this.data[0]]+a[this.data[1]]+a[this.data[2]]+a[this.data[3]]+"-"+a[this.data[4]]+a[this.data[5]]+"-"+a[this.data[6]]+a[this.data[7]]+"-"+a[this.data[8]]+a[this.data[9]]+"-"+a[this.data[10]]+a[this.data[11]]+a[this.data[12]]+a[this.data[13]]+a[this.data[14]]+a[this.data[15]]}};var my=class{constructor(){this.headers=[]}a(){const a=new Wx;ey(a,1,this.headers);return a.end()}getId(){return 1}};var jy=class{constructor(){}a(){return(new Wx).end()}getId(){return 6}};var py=class{constructor(a){this.j=a;this.f=this.h=this.time=this.sessionId=null}a(){const a=new Wx;ey(a,1,this.j);ey(a,2,this.sessionId);ey(a,3,this.time);by(a,4,null);dy(a,5,null);$x(a,6,this.h);fy(a,7,this.f);return a.end()}};var ky=class{constructor(){this.f=null;this.events=[]}a(){const a=new Wx;fy(a,1,this.f);ey(a,2,this.events);return a.end()}};var qy=class{constructor(){this.f=this.h=null}a(){const a=new Wx;by(a,1,this.h);$x(a,2,this.f);return a.end()}};var gy=class{constructor(){this.f=this.h=null}a(){const a=new Wx;by(a,1,this.h);$x(a,2,this.f);return a.end()}};var Qy=class{constructor(a,b,c,d,e,f,g,h,k){k=void 0===k?2500:k;this.o=a;this.l=h;this.w=new Py;this.A=new Py;this.a=[];this.h=setInterval(()=>ly(this),k);this.f=null;this.j=!1;oy(this,b,c,d,e,f,g)}dispose(){const a=this;return _.x(function*(){a.h&&(clearInterval(a.h),a.h=null);a.f&&(yield a.f);0<a.a.length&&(yield ly(a),a.a=[]);a.j=!0})}};var Ry=class{constructor(){this.reason=this.currentState=this.previousState=null}a(){const a=new Wx;$x(a,1,this.previousState);$x(a,2,this.currentState);$x(a,3,this.reason);ey(a,4,null);ey(a,5,null);ey(a,6,null);return a.end()}getId(){return 5}};var Vy=class extends _.Au{constructor(){super();this.m=null;this.a=this.l=!1;this.f=new _.ts;this.h=null;this.g=new _.R("clpp.sessions.SessionsPlugin");this.o=this.F.bind(this);this.j=this.C.bind(this)}onPlayerCreated(a){this.m=a}onContentWillLoad(a){var b=a.getConfiguration().sessions;(b=!(!b||typeof b!==_.Fe))||this.g.warn("Sessions plugin is loaded but not configured. Will do nothing.");if(this.l=b)b=a.getConfiguration().sessions,b.apiUrl?(this.g.debug(_.sa),this.g.info("Create a session and start sending events."),
a=_.vk(),this.h=new Qy(new Uint8Array([]),a.browser,a.browserVersion.name,a.os,a.osVersion.name,"prestoplay-web",_.fa,b.apiUrl),this.f.on(this.m,_.Nf,this.B.bind(this)),this.f.on(this.m,_.Ff,this.A.bind(this)),this.f.on(this.m,_.Ef,this.w.bind(this)),this.f.on(this.m,_.r,this.U.bind(this)),a=this.m.getNetworkEngine(),a.Rd(this.o),a.tc(this.j),a.j.push(this.j)):(this.g.warn(Sx),a.onError(new _.H(1,9,15E3,Sx)))}onPlayerWillRelease(){ry(this)}id(){return"sessions"}B(a){if(!this.a){a=a.detail;var b=a.currentState,
c=new Ry;c.previousState=zy(a.previousState);c.currentState=zy(b);Ay(this,c)}}A(){if(!this.a){var a=new Ry;a.previousState=zy(this.m.getState());a.currentState=Sy;Ay(this,a);this.a=!0}}w(){if(this.a){var a=new Ry;a.previousState=Sy;a.currentState=zy(this.m.getState());Ay(this,a);this.a=!1}}U(a){a=a.detail;var b=new Ny;b=new My(new Ly(b.getId(),new Uint8Array(b.a())));b.errorCode=a.code;b.message=a.message;b.f=a.stack;b.severity=a.severity===_.F?Ty:Uy;Ay(this,b)}F(a){const b=new Py;a.downloadId=b;
const c=new Ky(Iy(a.type,a.contentType),a.uris[0]);c.downloadId=b;c.headers=Object.keys(a.headers).map(d=>new ny(d,a.headers[d]));Ay(this,c)}C(a){var b=a.request.downloadId;b?(b=new Jy(b,a.data.byteLength,hy(a.timeMs||0),a.status||-1),b.f=Object.keys(a.headers).map(c=>new ny(c,a.headers[c])),Ay(this,b)):this.g.warn("Download ID is missing on download completed event.")}};_.dp(new class{create(){return new Vy}});var Uy=1,Ty=2;var sy=0,ty=2,yy=3,Sy=5,uy=6,vy=8,wy=10,xy=11;var By=0,Cy=1,Dy=2,Ey=3,Fy=4,Hy=5,Gy=9;};f.call(g, window);