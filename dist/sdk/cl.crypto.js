import {clpp} from "./cl.core.js";let g={};const _ = clpp._;var f=function(window){'use strict';var tS=function(a){a=_.li(a);const b=new Uint32Array(4);for(let c=0;4>c;c++)b[c]=a.getUint32(4*c);return b},vS=function(a,b){return c=>_.x(function*(){const d=c.request||null;if(d&&2===d.type&&d.keyInfo&&c.data){const e=d.uris[0];a.g.debug("Decrypting AES-128-encrypted video segment",e);c.data=yield uS(a,b,c.data,d.keyInfo,e)}return c})},uS=function(a,b,c,d,e){return _.x(function*(){let f=new ArrayBuffer(0);try{f=yield wS(a,b,d.url)}catch(g){return a.g.warn("Could not fetch AES key",
g),b.onError(new _.H(1,7,7104,null,g)),c}try{const g=a.l?new xS:new yS;yield g.importKey(f);return yield g.decrypt(c,d.iv)}catch(g){return a.g.warn("Could not decrypt segment data!",e,g),b.onError(new _.H(1,3,3103,null,g)),c}})},wS=function(a,b,c){return _.x(function*(){const d=_.Si(c),e=(new _.Mh(c)).Pa.endsWith(".drmtoday.com");if(e){var f=b.getConfiguration();_.Yl(d,f)}f=c+JSON.stringify(d.headers);if(a.j[f])return a.j[f];try{const g=yield b.getNetworkEngine().fetch(d).R;return a.j[f]=g.data}catch(g){throw e&&
1001===g.code&&412===g.data.status&&a.g.warn("Wrong DRMtoday credentials, server responded with 412."),g;}})},yS=class{constructor(){this.B=[0,1,2,4,8,16,32,64,128,27,54];this.C=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)];this.l=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)];this.A=new Uint32Array(256);this.o=new Uint32Array(256);this.w=new Uint32Array(0);this.h=this.a=this.j=this.f=null;{const c=this.A,d=this.o;var a=
this.C;const e=a[0],f=a[1],g=a[2];a=a[3];var b=this.l;const h=b[0],k=b[1],l=b[2];b=b[3];const m=new Uint32Array(256);let n=0,q=0,u;for(u=0;256>u;u++)m[u]=128>u?u<<1:u<<1^283;for(u=0;256>u;u++){let v=q^q<<1^q<<2^q<<3^q<<4;v=v>>>8^v&255^99;c[n]=v;d[v]=n;const y=m[n],B=m[y],D=m[B];let M=257*m[v]^16843008*v;e[n]=M<<24|M>>>8;f[n]=M<<16|M>>>16;g[n]=M<<8|M>>>24;a[n]=M;M=16843009*D^65537*B^257*y^16843008*n;h[v]=M<<24|M>>>8;k[v]=M<<16|M>>>16;l[v]=M<<8|M>>>24;b[v]=M;n?(n=y^m[m[m[D^y]]],q^=m[m[q]]):n=q=1}}}importKey(a){a=
tS(a);for(var b=!0,c=0;c<a.length&&b;)b=a[c]===this.w[c],c++;if(b)return new Promise(m=>m());this.w=a;this.a=a.length;if(4!==this.a&&6!==this.a&&8!==this.a)throw Error("Invalid aes key size\x3d"+this.a);this.h=4*(this.a+7);this.f=new Uint32Array(this.h);this.j=new Uint32Array(this.h);b=this.A;const d=this.B;var e=this.l;c=e[0];const f=e[1],g=e[2],h=e[3];let k=0,l=0;for(e=0;e<this.h;e++)e<this.a?k=this.f[e]=a[e]:(l=k,0===e%this.a?(l=l<<8|l>>>24,l=b[l>>>24]<<24|b[l>>>16&255]<<16|b[l>>>8&255]<<8|b[l&
255],l^=d[e/this.a|0]<<24):6<this.a&&4===e%this.a&&(l=b[l>>>24]<<24|b[l>>>16&255]<<16|b[l>>>8&255]<<8|b[l&255]),k=(this.f[e-this.a]^l)>>>0,this.f[e]=k);for(a=0;a<this.h;a++)e=this.h-a,l=a&3?this.f[e]:this.f[e-4],this.j[a]=4>a||4>=e?l:c[b[l>>>24]]^f[b[l>>>16&255]]^g[b[l>>>8&255]]^h[b[l&255]],this.j[a]>>>=0;return new Promise(m=>m())}decrypt(a,b){let c=0;const d=this.a+6,e=this.j,f=this.o;var g=this.l;const h=g[0],k=g[1],l=g[2];g=g[3];var m=tS(b);b=m[0];let n=m[1],q=m[2];m=m[3];a=_.ki(a);const u=new Int32Array(a.length);
let v,y,B;let D,M,da,vb,Ub,pd,kg,Wa,le;const Oc=this.F.bind(this);for(;c<a.length;){vb=Oc(a[c]);Ub=Oc(a[c+1]);pd=Oc(a[c+2]);kg=Oc(a[c+3]);D=vb^e[0];M=kg^e[1];da=pd^e[2];var ea=Ub^e[3];Wa=4;for(le=1;le<d;le++)v=h[D>>>24]^k[M>>16&255]^l[da>>8&255]^g[ea&255]^e[Wa],y=h[M>>>24]^k[da>>16&255]^l[ea>>8&255]^g[D&255]^e[Wa+1],B=h[da>>>24]^k[ea>>16&255]^l[D>>8&255]^g[M&255]^e[Wa+2],ea=h[ea>>>24]^k[D>>16&255]^l[M>>8&255]^g[da&255]^e[Wa+3],D=v,M=y,da=B,Wa+=4;v=f[D>>>24]<<24^f[M>>16&255]<<16^f[da>>8&255]<<8^f[ea&
255]^e[Wa];y=f[M>>>24]<<24^f[da>>16&255]<<16^f[ea>>8&255]<<8^f[D&255]^e[Wa+1];B=f[da>>>24]<<24^f[ea>>16&255]<<16^f[D>>8&255]<<8^f[M&255]^e[Wa+2];ea=f[ea>>>24]<<24^f[D>>16&255]<<16^f[M>>8&255]<<8^f[da&255]^e[Wa+3];Wa+=3;u[c]=Oc(v^b);u[c+1]=Oc(ea^n);u[c+2]=Oc(B^q);u[c+3]=Oc(y^m);b=vb;n=Ub;q=pd;m=kg;c+=4}return new Promise($a=>{{var Pa=u.buffer;const jb=Pa.byteLength,Rc=jb&&(new DataView(Pa)).getUint8(jb-1);Pa=Rc?Pa.slice(0,jb-Rc):Pa}$a(Pa)})}destroy(){this.B=this.j=this.f=this.l=this.C=this.o=this.A=
this.h=this.a=this.w=null;return new Promise(a=>a())}F(a){return a<<24|(a&65280)<<8|(a&16711680)>>8|a>>>24}};var xS=class{constructor(){this.a=null}importKey(a){const b=this;return _.x(function*(){b.a=yield crypto.subtle.importKey("raw",a,{name:"AES-CBC"},!1,["decrypt"])})}decrypt(a,b){const c=this;return _.x(function*(){return yield crypto.subtle.decrypt({name:"AES-CBC",iv:b},c.a,a)})}destroy(){this.a=null;return new Promise(a=>a())}};_.z("clpp.crypto.CryptoComponent",class extends _.Yt{constructor(){super();this.j={};this.l=!1;this.g=new _.R("clpp.crypto")}f(){if(window.crypto&&crypto.subtle){var a=crypto.subtle.decrypt;a=typeof crypto.subtle.importKey===_.Yd&&typeof a===_.Yd}else a=!1;(this.l=a)||this.g.warn("No WebCrypto APIs found. Will fallback to software AES")}o(a){const b=vS(this,a);a.getNetworkEngine().tc(b)}a(){this.j={}}id(){return"crypto"}});};f.call(g, window);