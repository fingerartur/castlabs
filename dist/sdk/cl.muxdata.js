import {clpp} from "./cl.core.js";let g={};const _ = clpp._;var f=function(window){'use strict';var sz=function(a){switch(a.type){case 1:return pz;case 2:return qz;case 3:return rz}},uz=function(a){const b=Object.keys(a).find(c=>tz.includes(c.toLowerCase()));return void 0!==b?a[b]:void 0},wz=function(a){let b={debug:!0,data:vz(a)};a.f&&a.f.muxOptionsOverride&&_.Tg(a.f.muxOptionsOverride)&&(b=_.Pg(b,a.f.muxOptionsOverride));b=_.Pg(b,{getPlayheadTime:()=>1E3*a.m.getPosition(),getStateData:()=>{{a.g.debug("getStateData()");var c=a.m.getLoadedSource(),d=a.m.getTrackManager();const f=
a.m.getSurface();var e={player_is_paused:a.m.isPaused(),player_is_fullscreen:f.isFullscreen(),video_source_duration:1E3*a.m.getDuration(),player_autoplay_on:!!a.m.getConfiguration().autoplay};if(c){const k=new _.Kl(c.url);e.video_source_url=_.jj(k);e.video_source_mime_type=c.type;c.name&&(e.video_title=c.name)}if(c=f.getContainer())e.player_width=c.offsetWidth,e.player_height=c.offsetHeight;(c=a.m.getSurface().getMedia())?c={videoWidth:c.videoWidth,videoHeight:c.videoHeight}:(c=a.m.getTrackManager().oa(),
c={videoWidth:c.width,videoHeight:c.height});const {videoWidth:g,videoHeight:h}=c;a.g.debug(`Video dimensions: ${g}x${h}`);g&&h&&(e.video_source_height=g,e.video_source_width=h);(d=d.na())&&d.language&&(e.player_language_code=d.language)}return e}});a.g.debug("Mux SDK options",b);return b},xz=function(a){_.ph(a.a);a.j.gd(a.F);a.j.ye(a.C)},vz=function(a){const b={env_key:a.f.envKey,video_title:a.o&&a.o.name||"",player_name:_.ra,player_software_name:_.ra,player_software_version:_.fa,player_mux_plugin_name:"CastlabsPlayer built-in Mux Plugin",
player_mux_plugin_version:_.fa};(a=a.m.getConfiguration().viewerId)&&(b.viewer_user_id=a);return b},yz=function(a){a.a.on(a.m,_.Xf,()=>{const b={player_playhead_time:1E3*a.m.getPosition()};a.emit(_.Xf,b)});a.a.on(a.m,_.Te,()=>a.emit(_.Te));a.a.on(a.m,_.Nc,a.G.bind(a));a.a.on(a.m,_.Nf,a.I.bind(a));a.a.on(a.m,_.gg,()=>a.emit(_.Ff));a.a.on(a.m,_.fg,()=>a.emit(_.Ef));a.a.on(a.m,_.r,a.H.bind(a));a.a.on(a.m,_.cc,()=>a.emit("adbreakstart"));a.a.on(a.m,_.dc,()=>a.emit("adbreakend"));a.a.on(a.m,_.qc,()=>{a.emit("adplay");
a.emit("adplaying")});a.a.on(a.m,_.mc,()=>a.emit("adpause"));a.a.on(a.m,_.oc,()=>{a.emit("adplay");a.emit("adplaying")});a.a.on(a.m,_.rc,()=>a.emit("adended"));a.a.on(a.m,_.hc,()=>a.emit("adfirstquartile"));a.a.on(a.m,_.lc,()=>a.emit("admidpoint"));a.a.on(a.m,_.sc,()=>a.emit("adthirdquartile"));a.j.tc(a.F);a.j.Rd(a.C);a.a.on(a.m,_.r,b=>{if((b=b.detail)&&1===b.category){var c=b.data;c=c&&c.request;if(void 0!==c&&!0===(1===c.type||2===c.type||3===c.type))if(7001===b.code){b=c;c=b.requestStartTimestamp;
var d=new _.Kl(b.uris[b.uriIndex]);b={request_start:c,request_type:sz(b),request_hostname:d.a};a.g.debug("onRequestCanceled()","Track event: requestcanceled",b);a.emit("requestcanceled",b)}else{{d=c.requestStartTimestamp;const f=new _.Kl(c.uris[c.uriIndex]);var e=b.data;e=void 0===e?-1:void 0!==e.response?e.response.status:void 0!==e.status?e.status:-1;b={request_start:d,request_type:sz(c),request_hostname:f.a,request_error:`${sz(c)}${"LoadError"}`,request_error_code:e,request_error_text:b.toString()};
a.g.debug("onRequestFailed()","Track event: requestfailed",b);a.emit("requestfailed",b)}}}})},zz=function(a){return!_.A(a)&&typeof a.init===_.Yd&&typeof a.emit===_.Yd},pz="manifest",qz="media",rz="encryption",tz=["x-request-id","cf-ray","x-amz-cf-id","x-akamai-request-id"];var Az=class{constructor(a,b){this.m=a;this.o=this.f=null;this.B=("000000"+(Math.random()*Math.pow(36,6)<<0).toString(36)).slice(-6);this.a=new _.ts;this.g=b;this.A=this.l=this.h=!1;this.w=null;this.j=a.getNetworkEngine();this.F=this.J.bind(this);this.C=this.K.bind(this)}initialize(a,b,c){this.f=a;this.o=b;this.w=c;if(!this.h){try{this.h=!0,this.w.init(this.B,wz(this))}catch(d){throw this.h=!1,xz(this),new _.H(1,9,9302,null,d);}this.emit("playerready")}this.l&&!this.A&&(a=vz(this),this.emit("videochange",
a),this.l=!1);yz(this)}release(){this.g.debug("release()");this.l?this.g.debug(_.ja):(xz(this),this.l=!0,this.o=this.f=null)}destroy(){this.g.debug(_.Ed);this.A?this.g.debug(_.ia):(this.A=!0,this.emit("destroy"))}emit(a,b){if(null===this.w)throw new _.H(1,9,9301);this.w.emit(this.B,a,b)}G(a){this.g.debug(_.Ge);var b=a.detail;a=this.m.getTrackManager();b&&b.bandwidth&&(b=b.bandwidth,(a=a.Qa())&&a.bandwidth&&(b+=a.bandwidth),this.emit("renditionchange",{video_source_bitrate:b}))}I(a){this.g.debug(_.Ke);
switch(a.detail.currentState){case _.Xn:this.m.getConfiguration().autoplay&&this.emit(_.Te);break;case _.Zn:this.emit(_.df);break;case _.Yn:this.emit(_.Pe);break;case _.On:this.emit(_.Vd)}}H(a){this.g.debug(_.He);if(this.h&&(a=a.detail||null))if(10003===a.code)this.emit("aderror");else if(a.severity===_.F){var b=a.message||"Player error";if(1===a.category||6100===a.code||6007===a.code)b="Download error",6100===a.code?b="Certificate request error":6007===a.code&&(b="License request error"),b=`${b} castlabs-error-data:${JSON.stringify(a.data)}`;
this.emit(_.r,{player_error_code:a.code,player_error_message:b})}}J(a){var b=a.request;if(b=void 0!==b&&!0===(1===b.type||2===b.type||3===b.type))b=a.status,b=void 0!==b&&200<=b&&299>=b;if(b){{b=a.request;const e=a.headers,f=b.bytesLoaded,g=b.requestStartTimestamp;var c=b.startTime,d=b.endTime;const h=g+a.responseStartMs;a=g+a.timeMs;c=c&&d?d-c:void 0;d=new _.Kl(b.uris[b.uriIndex]);a={request_start:g,request_type:sz(b),request_hostname:d.a,request_id:uz(e),request_bytes_loaded:f,request_response_start:h,
request_response_end:a,request_response_headers:e,request_media_duration:c,request_url:_.jj(d)};this.g.debug("onRequestCompleted()","Track event: requestcompleted",a);this.emit("requestcompleted",a)}}}K(a){a.requestStartTimestamp=Date.now()}};var Bz=class extends _.Au{constructor(){super();this.f=this.m=null;this.a=!1;this.g=new _.R("clpp.muxdata")}onPlayerCreated(a){this.m=a;this.f=new Az(a,this.g)}onContentWillLoad(a,b){var c=a.getConfiguration();c=_.Qg(c.muxdata);try{var d=[];typeof c===_.Fe&&(c.envKey||d.push("envKey"));if(0<d.length)throw new _.H(1,9,9300,{missingKeys:d});{const f=a.getConfiguration();d=null;if(this.a=!_.A(f.muxdata)&&typeof f.muxdata===_.Fe){const g=f.muxdata;d=zz(g.muxLib)?g.muxLib:window.mux;if(!zz(d)){this.g.warn("Mux SDK is not loaded. Will do nothing.");
this.a=!1;const h=new _.H(1,9,9301);this.U(a,h)}}else this.g.warn("Mux plugin is loaded but not configured. Will do nothing.");var e=d}null!==e&&this.f.initialize(c,b,e)}catch(f){this.a=!1,this.U(a,f)}}onContentLoaded(){}onPlayerWillDestroy(){this.a&&(this.f.destroy(),this.m=this.f=null)}onPlayerWillRelease(){this.a&&this.f.release()}id(){return"mux"}emit(a,b){try{this.f.emit(a,b)}catch(c){throw null!==this.m&&this.U(this.m,c),c;}}U(a,b){a.trigger(new _.E(_.r,{detail:b}))}};
_.z("clpp.muxdata.MuxDataPlugin",Bz);Bz.prototype.emit=Bz.prototype.emit;Bz.Id="mux";_.dp(new class{create(){return new Bz}});};f.call(g, window);