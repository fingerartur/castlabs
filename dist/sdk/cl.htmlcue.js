import {clpp} from "./cl.core.js";let g={};const _ = clpp._;var f=function(window){'use strict';var KQ="Unsupported unit",LQ="clpp-text-plain",MQ="clpp-text-ttml",NQ="clpp.htmlcue.HtmlTextDisplayer",OQ="initial",PQ=function(a){return _.Eh(a,{af:(b,c)=>b.zc(c)})},QQ=function(a,b){if(0===b.length)return a;let c=a;a=a.findIndex(d=>d.startTime>=b[0].startTime);0<=a&&(c=c.slice(0,a));return c.concat(b)},RQ=function(a,b){let c=0,d=a.length-1;for(;c<=d;){const e=c+d>>1,f=b(a[e]);if(0===f)return e;0<f?c=e+1:d=e-1}return-1},SQ=function(a){if(!a.input)return null;var b=a.input.match(/^([^<]*)(<[^>]+>?)?/);
b=b[1]?b[1]:b[2];a.input=a.input.substr(b.length);return b},UQ=function(a){let b=null;for(;b=a.match(/&(amp|lt|gt|lrm|rlm|nbsp);/);)a=a.replace(b[0],c=>TQ[c]);return a},WQ=function(a,b){VQ(a,b);Array.from(b.getElementsByTagName("*")).forEach(c=>{VQ(a,c)})},VQ=function(a,b){for(const c in a)null!=a[c]&&(b.style[c]=a[c])},XQ=function(a,b){return 0===a?"0":a+b},YQ=function(a,b){return 1>Math.abs(a-b)||a<b},ZQ=function(a,b){return a<b&&1<Math.abs(a-b)},$Q=function(a,b){return a>b&&1<Math.abs(a-b)},aR=
function(a,b){return 1>Math.abs(a-b)||a>b},cR=function(a){const b=a.getBoundingClientRect();var c=getComputedStyle(a,null);const d=parseFloat(c.getPropertyValue("border-left-width"))||0,e=parseFloat(c.getPropertyValue("border-right-width"))||0;var f=parseFloat(c.getPropertyValue("border-top-width"))||0;c=parseFloat(c.getPropertyValue("border-bottom-width"))||0;const g=(b.top||a.offsetTop)+f;f=(b.height||a.offsetHeight)-f-c;return new bR(b.left+d,b.right+e,g,(b.bottom||g+f)+c,f,(b.width||a.offsetWidth)-
d-e)},dR=function(a){return new bR(a.left,a.f,a.top,a.a,a.height,a.width)},eR=function(a,b){return b.some(c=>ZQ(a.left,c.f)&&$Q(a.f,c.left)&&ZQ(a.top,c.a)&&$Q(a.a,c.top))},fR=function(a,b){return aR(a.top,b.top)&&YQ(a.a,b.a)&&aR(a.left,b.left)&&YQ(a.f,b.f)},gR=function(a,b,c){switch(c){case "+x":return ZQ(a.left,b.left);case "-x":return $Q(a.f,b.f);case "+y":return ZQ(a.top,b.top);case "-y":return $Q(a.a,b.a);default:throw Error("Unknown axis");}},hR=function(a){return a.f.writingMode===_.xs},iR=
function(a){var b=a.a.childNodes[0],c=a.a.getBoundingClientRect();const d=b.getClientRects();b=c.height/d.length;c=c.width/d.length;return hR(a)?b:c},jR=function(a){switch(a.f.writingMode){case _.xs:return"horizontal-tb";case _.ig:return _.ig;case _.jg:return _.jg;default:throw Error("Unknown writing mode");}},kR=function(a){switch(a.f.positionAlign){case _.ke:return _.he;case "auto":case _.ad:return _.ws;case _.me:return _.zf}return a.f.textAlign},lR=function(a,b){if(typeof a.f.position===_.t&&typeof a.f.size===
_.t)switch(b){case _.ke:return a.f.position;case "auto":case _.ad:return a.f.position-a.f.size/2;case _.me:return a.f.position-a.f.size}return 0},mR=function(a){if(!a.f.positionAlign)switch(a.f.textAlign){case _.he:case _.he:return _.ke;case _.ws:return _.ad;case _.zf:case _.zf:return _.me}return a.f.positionAlign},pR=function(a,b,c){return(nR(a)||oR(a))&&_.Xg(c)?XQ(c,_.sf):nR(a)&&_.A(c)?XQ(0,_.sf):hR(a)&&_.Xg(b)?XQ(b,"%"):OQ},qR=function(a,b,c){return hR(a)&&_.Xg(c)?XQ(c,_.sf):(nR(a)||oR(a))&&_.Xg(b)?
XQ(b,"%"):OQ},oR=function(a){return a.f.writingMode===_.jg},nR=function(a){return a.f.writingMode===_.ig},rR=function(a,b){if(a.j)switch(b.writingMode){case _.xs:return["-y"];case _.ig:return["+x"];case _.jg:return["-x"]}a=[];switch(b.writingMode){case _.xs:a=["+y","-y"];break;case _.ig:a=["+x","-x"];break;case _.jg:a=["-x","+x"]}0>b.line&&(a=a.reverse());return a},sR=function(a){for(a.h=[];0<a.f.childNodes.length;)a.f.removeChild(a.f.childNodes[0]);a.a=cR(a.l.a)},tR=function(a,b){sR(a.h);a.l.unshift(b);
for(const c of a.l)a.h.append(c)},uR=function(a,b,c){a=a.f;const d=a.viewportAnchorUnits;if(d===_.Es)return a.viewportAnchorY/100*c-a.regionAnchorY/100*b;if(0===d)return a.viewportAnchorY-a.regionAnchorY;throw Error(KQ);},wR=function(a,b,c,d){const e=document.createElement(_.Sf),f=e.dataset;f.name=b;f.for=c;d&&(f.name=`${b} (sandbox)`,f.sandbox=!0);c=document.head;c.appendChild(e);vR(a,c,b);a.g.debug(`Created HTML style element #${b}.`);return e.sheet},xR=function(a,b){a=`.${a.j} .clpp-text-container`;
const c=`${a} .clpp-text-cue`;return b=b.replace(/::cue\((#[^)]+)\)/g,`${a} $1`).replace(/::cue\(([^)]+)\)/g,`${c} $1`).replace(/::cue-region\(([^)]+)\)/g,`${a} $1 .clpp-text-cue`).replace(/::cue/g,c).replace(/::cue-region/g,`${a} .clpp-text-cue-region .clpp-text-cue`).replace(/::ttml/g,a)},yR=function(a,b){let c=!1;try{a.f.insertRule(b,0);const d=a.f.cssRules[0];d instanceof CSSStyleRule&&(c=d.selectorText.split(",").every(e=>0===e.trim().indexOf(`.${a.j} `)))}catch(d){}0<a.f.cssRules.length&&a.f.deleteRule(0);
return c},zR=function(a){if(null!=a.a){for(;0<a.a.cssRules.length;)a.a.deleteRule(0);a.o=[]}},vR=function(a,b,c){const d=new MutationObserver(e=>{e.forEach(f=>{f.removedNodes.forEach(g=>{g.id===c&&a.g.error(`PRESTOplay HTML style element #${c} has `+"been unexpectedly removed! Some styles will not work!")})})});d.observe(b,{subtree:!1,childList:!0});a.l.push(()=>d.disconnect())},AR=function(a){a=_.Qg(a.htmlcue||{});_.A(a.stretchSmpteImage)&&(a.stretchSmpteImage=!1);_.A(a.enableResizeObserver)&&(a.enableResizeObserver=
!0);return a},GR=function(a,b){if((b||a.l)&&a.F){var c=a.m.getPosition();if(b||a.J!==c&&a.m.getState()===_.Zn)if(a.J=c,c=BR(a,c),b||(b=a.o,b=!(null===b&&null===c||null!==b&&null!==c&&b.start===c.start&&b.end===c.end)),b&&(a.o=c,CR(a),c)){b={color:a.getFontColor()||void 0,backgroundColor:a.getBackgroundColor()||void 0,fontFamily:a.getFontFamily()||void 0,textShadow:_.ns(a)||void 0};c=a.f.slice(c.start,c.end+1);for(const k of c){c=a;var d=k,e=b,f=c.a.a,g=null;switch(d.payloadType){case _.ug:g="clpp-text-vtt";
break;case _.Zf:g=MQ;break;case _.vs:g=LQ}g&&!f.classList.contains(g)&&_.vo(f,g);f=cR(c.a.a);if(0===f.width||0===f.height)c.g.warn("The height or width of the `.clpp-text-container` element is zero. Captions will not be displayed. Please check if the `clpp.styles.css` file has been included.");else{VQ({fontSize:DR(c,d.containerRows)},c.a.a);f=null;g=d.payloadType===_.ug;var h=d.payloadType===_.Zf;d.region&&(g||h||d.backgroundImage)&&(c.B.has(d.region.id)?f=c.B.get(d.region.id):(f=new ER(d.region,
{}),c.B.set(d.region.id,f),tR(c.a,f)));d=new FR(d,c.L,e);f?tR(f,d):tR(c.a,d)}}}}},HR=function(a){CR(a);a.J=null;a.o=null;a.f=[]},IR=function(a,b){return a.startTime<=b&&a.endTime>b},BR=function(a,b){var c=RQ(a.f,d=>IR(d,b)?0:b!==d.startTime?b-d.startTime:b-d.endTime);if(-1===c)return null;{let d=c;for(;0<=d-1&&IR(a.f[d-1],b);)d--;for(;c+1<a.f.length&&IR(a.f[c+1],b);)c++;return{start:d,end:c}}},CR=function(a){a.B.clear();if(a.a){const b=a.a.a;b.classList.remove("clpp-text-vtt");b.classList.remove(MQ);
b.classList.remove(LQ);a=a.a;sR(a.h);a.l=[]}},DR=function(a,b){const c=cR(a.a.a).height;if(null!==a.I)return a.getFontSize();if(null!==a.C)return a=a.getFontSizePercent(),`${Math.round(c*a)}px`;if(typeof b===_.t&&0<b)return`${Math.round(c/b)}px`;a=a.getFontSizePercent();return`${Math.round(c*a)}px`},MR=class{parse(a){a={input:a};const b=_.xo(_.Gd),c=[];let d=b;for(var e;null!==(e=SQ(a));)if("\x3c"===e[0])if("/"===e[1])c.length&&c[c.length-1]===e.substr(2).replace("\x3e","")&&(c.pop(),d=d.parentNode);
else{if(e=e.match(/^<([^.\s/0-9>]+)(\.[^\s\\>]+)?([^>\\]+)?(\\?)>?$/)){var f=e[1];var g=e[3];var h=JR[f];h?(h=_.xo(h),(f=KR[f])&&g&&h.setAttribute(f,g.trim()),g=h):g=null;!g||LR[g.localName]&&LR[g.localName]!==d.localName||(e[2]&&(g.className=e[2].substr(1).replace(/\./g," ")),c.push(e[1]),d.appendChild(g),d=g)}}else d.appendChild(document.createTextNode(UQ(e)));return b}},JR={c:"c",i:"i",b:"b",u:"u",ruby:"ruby",rt:"rt",v:"v",lang:"lang"},KR={v:"voice",lang:"lang"},LR={rt:"ruby"},TQ={"\x26amp;":"\x26",
"\x26lt;":"\x3c","\x26gt;":"\x3e","\x26lrm;":"\u200e","\x26rlm;":"\u200f","\x26nbsp;":"\u00a0"};var bR=class{constructor(a,b,c,d,e,f){this.left=a;this.f=b;this.top=c;this.a=d;this.height=e;this.width=f}};var NR=class{constructor(a,b,c){this.id=a;this.w=b;this.B=c;this.a=this.o();this.j=!1}init(){this.j=!0}A(){return!1}};var FR=class extends NR{constructor(a,b,c){super(a.id,"clpp-text-cue",{});this.l=b;this.f=a;this.h=!!this.f.backgroundImage;this.C=c}A(){return!this.h&&!(this.f.region&&this.f.region.displayAlign)}init(a){super.init(a);if(this.h)_.vo(this.a,"clpp-text-cue-image"),this.a.style.backgroundImage=`url("${this.f.backgroundImage}")`,this.l.stretchSmpteImage&&(this.a.style.backgroundSize="contain");else if(a){var b=this.f;if(b.payloadType===_.Zf){var c=_.xo(_.Gd);c.innerHTML=b.payload;b=c}else b.payloadType===
_.ug?b=(new MR).parse(b.payload):(c=_.xo(_.Gd),c.textContent=b.payload,b=c);_.vo(b,this.w);this.id&&(b.id=this.id);for(d of this.f.cssClassList)_.vo(b,d);VQ({writingMode:jR(this)},b);var d=b;this.a.appendChild(d);_.vo(this.a,"clpp-text-wrapper");for(var e of this.f.cssClassList)_.vo(this.a,`clpp-text-wrapper__${e}`);_.A(this.f.line)&&(this.f.lineInterpretation=_.ys,this.f.line=hR(this)?-1:0);e=jR(this);VQ({writingMode:e,webkitWritingMode:e,direction:OQ,textAlign:kR(this)},this.a);if(!this.f.region||
!this.f.region.displayAlign){e=lR(this,mR(this));VQ({position:"absolute",left:pR(this,e,null),right:oR(this)&&_.A(null)?XQ(0,_.sf):OQ,top:qR(this,e,null),width:hR(this)?XQ(this.f.size,"%"):OQ,height:nR(this)||oR(this)?XQ(this.f.size,"%"):OQ},this.a);b=this.f;a=hR(this)?a.height:a.width;c=iR(this);if(b.lineInterpretation===_.ys){var f=c*Math.round(b.line);Math.abs(f)>a&&(f=c*(0>b.line?0:-1));0>f&&(f+=a)}else{f=c/a*100;let g=b.line;switch(b.lineAlign){case _.ad:g-=f/2;break;case _.Ud:g-=f}f=Math.round(g/
100*a)}oR(this)&&(f=a-f-c);a=f;VQ({left:pR(this,e,a),right:oR(this)&&_.A(a)?XQ(0,_.sf):OQ,top:qR(this,e,a)},this.a)}WQ(this.C,d)}}o(){return _.xo(_.Gd)}};var OR=class{constructor(a,b){this.l=a;this.f=a.a;this.j=void 0===b?!1:b;this.a=cR(a.a);this.h=[]}append(a){const b=a.a;b.style.visibility=_.$d;this.f.appendChild(b);a.j||a.init(this.a);if(a.A()){a:{var c=cR(a.a);var d=rR(this,a.f),e=iR(a);const g=dR(c);let h=null,k=0;for(const l of d){for(;gR(c,this.a,l)||fR(c,this.a)&&eR(c,this.h);){d=c;var f=e;switch(l){case "+x":d.left+=f;d.f+=f;break;case "-x":d.left-=f;d.f-=f;break;case "+y":d.top+=f;d.a+=f;break;case "-y":d.top-=f,d.a-=f}}if(this.j||fR(c,this.a))break a;
d=this.a;d=Math.max(0,Math.min(c.f,d.f)-Math.max(c.left,d.left))*Math.max(0,Math.min(c.a,d.a)-Math.max(c.top,d.top))/(c.height*c.width);d>k&&(h=dR(c),k=d);c=dR(g)}c=h||g}VQ({top:XQ(c.top-this.a.top,_.sf),bottom:XQ(this.a.a-c.a,_.sf),left:XQ(c.left-this.a.left,_.sf),right:XQ(this.a.f-c.f,_.sf),height:XQ(c.height,_.sf),width:XQ(c.width,_.sf)},a.a)}b.style.visibility="visible";this.h.push(cR(a.a))}};var PR=class extends NR{constructor(a,b,c){super(a,b,c);this.h=null;this.l=[]}init(){this.h=new OR(this);this.j=!0}o(){const a=_.xo(_.Gd);_.vo(a,this.w);this.id&&(a.id=this.id);return a}};var ER=class extends PR{constructor(a,b){super(a.id,"clpp-text-cue-region",b);this.f=a}init(a){a:{var b=this.f;switch(b.widthUnits){case 0:b=b.width;break a;case _.Es:b=b.width/100*a.width;break a;default:throw Error(KQ);}}var c=this.f;var d=c.viewportAnchorUnits;if(d===_.Es)c=c.viewportAnchorX/100*a.width-c.regionAnchorX/100*b;else if(0===d)c=c.viewportAnchorX-c.regionAnchorX;else throw Error(KQ);d=a.height;const e=uR(this,d,a.height);VQ(this.B,this.a);VQ({left:XQ(c,_.sf),top:XQ(e,_.sf),width:XQ(b,
_.sf),height:XQ(d,_.sf)},this.a);this.f.writingMode&&VQ({display:"flex","flex-direction":this.f.writingMode},this.a);this.f.displayAlign&&VQ({"justify-content":this.f.displayAlign},this.a);for(var f of this.f.cssClassList)_.vo(this.a,f);a:switch(f=this.f,f.heightUnits){case 0:f=f.height;break a;case _.Es:f=f.height/100*a.height;break a;case 2:f=f.height;c=new FR(new _.Bs(0,1,"Lorem ipsum",_.vs),{},{});b=c.a;this.a.appendChild(b);c.init(cR(this.a));c=b.getBoundingClientRect().height;this.a.removeChild(b);
b=c;f*=b;break a;default:throw Error(KQ);}a=uR(this,f,a.height);VQ({top:XQ(a,_.sf),height:XQ(f,_.sf)},this.a);this.h=new OR(this,!0);this.j=!0}getId(){return this.f.id}};var QR=class{constructor(a,b){this.g=new _.R("clpp.htmlcue.StyleManager");this.l=[];this.j=a;this.h=b;this.o=[];this.a=wR(this,this.h,this.j);this.f=wR(this,this.h,this.j,!0);this.f.disabled=!0;this.g.debug(`Stylesheet ${this.h} has been created.`)}appendRule(a){if(null!=this.a&&!this.o.some(b=>b===a)){const b=xR(this,a);if(yR(this,b)){try{this.a.insertRule(b,this.a.cssRules.length),this.g.debug(`Added CSS rule ${b}`)}catch(c){this.g.error(`An error occurred when adding a CSS rule: ${b}`)}this.o.push(a)}else this.g.warn(`Stylesheet ${this.h} ignoring the CSS rule `+
`because it's not safe: ${b}`)}}destroy(){const a=this;return _.x(function*(){null!=a.a&&(a.l.forEach(b=>b()),a.l=[],zR(a),document.head.removeChild(a.a.ownerNode),document.head.removeChild(a.f.ownerNode),a.a=null,a.f=null,a.g.debug(`Stylesheet ${a.h} has been destroyed.`))})}};var RR=class extends _.xu{constructor(a){super(a);this.g=new _.R(NQ);this.m=a;this.L=AR(a.getConfiguration());this.l=!1;this.f=[];this.F=a.getSurface().getContainer();this.j=new QR(a.getSurface().getUniqueCssClass(),"CLPP Subtitle Styles");this.a=new PR(null,"clpp-text-container",{});this.A=new _.ou(a.getSurface(),this.T.bind(this));this.J=null;this.F?(this.F.appendChild(this.a.a),this.a.init(null)):this.g.warn("No container element! Subtitles will not appear. Please check your player surface configuration or switch to NativeTextDisplayer.");
this.G=new _.Tj(()=>{GR(this)});this.B=new Map;this.o=null}append(a,b){if(null!=this.j&&0!==a.length){for(const c of b)this.j.appendRule(c);a.sort((c,d)=>c.startTime!==d.startTime?c.startTime-d.startTime:c.endTime-d.endTime);this.f=QQ(this.f,PQ(a));this.o=null;GR(this,!1)}}h(){null==this.j||GR(this,!0)}destroy(){const a=this;return _.x(function*(){null!=a.j&&(HR(a),a.G.stop(),yield a.j.destroy(),a.j=null,a.F.removeChild(a.a.a),a.a=null,a.A.stop(),a.A=null,a.l=!1)})}remove(a,b){if(null==this.j)return!1;
this.f=this.f.filter(c=>c.startTime<a||c.endTime>=b);this.o=null;GR(this,!0);return!0}isTextVisible(){return this.l}setTextVisibility(a){null!=this.j&&this.l!==a&&((this.l=a)?(this.G.kb(.25),this.L.enableResizeObserver&&this.A.start(),GR(this,!0)):(this.G.stop(),this.A.stop(),HR(this)))}Rc(){return this.f}T(){GR(this,!0)}};_.z(NQ,RR);RR.prototype.setTextVisibility=RR.prototype.setTextVisibility;RR.prototype.isTextVisible=RR.prototype.isTextVisible;RR.prototype.remove=RR.prototype.remove;
RR.prototype.destroy=RR.prototype.destroy;RR.prototype.append=RR.prototype.append;var SR=class{isSupported(a){return!!a.enableHtmlCue&&!_.jk()}create(a){return new RR(a)}};_.z("clpp.htmlcue.HtmlCueComponent",class extends _.Yt{f(){_.Dn(_.be,new SR)}a(){_.Bn.has(_.be)&&(_.Bn.delete(_.be),_.Cn.info("Removed factory: 'html'"))}id(){return _.Tf}});};f.call(g, window);