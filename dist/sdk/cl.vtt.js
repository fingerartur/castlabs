import {clpp} from "./cl.core.js";let g={};const _ = clpp._;var f=function(window){'use strict';var Ju=" The setting will be ignored.",Ku="VTT parser encountered an invalid VTT setting: ",Lu="application/x-subrip",Mu="text/srt",Nu='text/vtt; codecs\x3d"vtt"',Ou='text/vtt; codecs\x3d"wvtt"',Pu=function(a){return a.a===a.f.length?null:(a=_.Ji(a,/[^ \t\n]*/gm))?a[0]:null},Qu=function(a){_.Ji(a,/[ \t]+/gm)},Ru=function(a){let b="";for(a=a.split(/\n/);3<a.length;){for(var c=3;c<a.length;++c)a[2]+=`\n${a[c]}`;a.splice(3,a.length-3)}if(3!==a.length)return"";c=0;!a[0].match(/\d+:\d+:\d+/)&&
a[1].match(/\d+:\d+:\d+/)&&(b+=`${a[0].match(/\w+/)}\n`,++c);if(a[c].match(/\d+:\d+:\d+/)){const d=a[1].match(/(\d+):(\d+):(\d+)(?:,(\d+))?\s*--?>\s*(\d+):(\d+):(\d+)(?:,(\d+))?/);if(d)b+=`${d[1]}:${d[2]}:${d[3]}.${d[4]} --> `,b+=`${d[5]}:${d[6]}:${d[7]}.${d[8]}\n`,++c;else return""}else return"";a[c]&&(b+=`${a[c]}\n\n`);return b},Su=function(a){a=_.Ji(a,/(?:(\d{1,}):)?(\d{2}):(\d{2})\.(\d{2,3})/g);if(null==a)return null;const b=Number(a[2]),c=Number(a[3]);return 59<b||59<c?null:Number(a[4])/1E3+
c+60*b+3600*(Number(a[1])||0)},Uu=function(a,b,c){let d;if(d=/^align:(start|middle|center|end|left|right)$/.exec(b))b=d[1],"middle"===b?a.textAlign=_.ws:a.textAlign=_.Cs[b.toUpperCase()];else if(d=/^vertical:(lr|rl)$/.exec(b))a.writingMode="lr"===d[1]?_.ig:_.jg;else if(d=/^size:([\d.]+)%$/.exec(b))a.size=Number(d[1]);else if(d=/^position:([\d.]+)%(?:,(line-left|line-right|center|start|end))?$/.exec(b))a.position=Number(d[1]),d[2]&&(b=d[2],a.positionAlign=b===_.ke||b===_.Mf?_.ke:b===_.me||b===_.Ud?
_.me:_.ad);else if(d=/^region:(.*)$/.exec(b)){if(b=Tu(c,d[1]))a.region=b}else{a:{if(c=/^line:([\d.]+)%(?:,(start|end|center))?$/.exec(b))a.lineInterpretation=1,a.line=Number(c[1]),c[2]&&(a.lineAlign=_.Ds[c[2].toUpperCase()]);else if(c=/^line:(-?\d+)(?:,(start|end|center))?$/.exec(b))a.lineInterpretation=_.ys,a.line=Number(c[1]),c[2]&&(a.lineAlign=_.Ds[c[2].toUpperCase()]);else{a=!1;break a}a=!0}return a}return!0},Tu=function(a,b){a=a.filter(c=>c.id===b);return a.length?a[0]:(_.C("VTT parser could not find a region with id: ",
b," The region will be ignored."),null)},Wu=function(a,b,c){let d,e,f;(new _.Ml).M("payl",_.Hl(g=>{d=_.oi(g)})).M("iden",_.Hl(g=>{e=_.oi(g)})).M("sttg",_.Hl(g=>{f=_.oi(g)})).parse(a);return d?Vu(d,e,f,b,c):null},Vu=function(a,b,c,d,e){a=new _.Bs(d,e,a,_.ug);b&&(a.id=b);if(c)for(b=new _.Ki(c),c=Pu(b);c;)Uu(a,c,[])||_.C(Ku,c,Ju),Qu(b),c=Pu(b);return a},Xu=class{a(a){a=_.oi(a);a=a.replace(/\r+/g,"");a=a.replace(/^\s+|\s+$/g,"");a=a.replace(/<[a-zA-Z\\/][^>]*>/g,"");a=a.split("\n\n");let b="";if(0<a.length){b+=
"WEBVTT\n\n";for(const c of a)b+=Ru(c)}return _.si(b)}},Yu=class{create(){return new Xu}probe(a,b){return(a===Mu||a===Lu)&&b===_.Vf}};var Zu=class{constructor(a){this.a=a}parseInit(){}parseMedia(a,b){a=_.oi(a);a=a.replace(/\r\n|\r(?=[^\n]|$)/gm,"\n");var c=a.split(/\n{2,}/m);if(!/^WEBVTT($|[ \t\n])/m.test(c[0]))throw new _.H(_.F,2,2E3);a=b.periodStart;if(c[0].includes("X-TIMESTAMP-MAP")){var d=c[0].match(/LOCAL:((?:(\d{1,}):)?(\d{2}):(\d{2})\.(\d{3}))/m),e=c[0].match(/MPEGTS:(\d+)/m);if(d&&e){a=Su(new _.Ki(d[1]));if(null==a)throw new _.H(_.F,2,2E3);e=Number(e[1]);for(d=b.segmentStart;95443.7176888889<=d;)d-=95443.7176888889,e+=
8589934592;a=b.periodStart+e/9E4-a}}else this.a.streaming.relativeTextTimestamp&&null!==b.segmentStart&&(a=b.segmentStart);b=[];for(var f of c)if(/^region/.test(f.toLowerCase())){e=new _.Ki(f.replace(/\n/g," "));d=new _.Gs;Pu(e);Qu(e);for(var g=Pu(e);g;){a:{var h;var k=d;var l=g;if(h=/^id:(.*)$/.exec(l))k.id=h[1];else if(h=/^width:(\d{1,2}|100)%$/.exec(l))k.width=Number(h[1]);else if(h=/^lines:(\d+)$/.exec(l))k.height=Number(h[1]),k.heightUnits=2;else if(h=/^regionanchor:(\d{1,2}|100)%,(\d{1,2}|100)%$/.exec(l))k.regionAnchorX=
Number(h[1]),k.regionAnchorY=Number(h[2]);else if(h=/^viewportanchor:(\d{1,2}|100)%,(\d{1,2}|100)%$/.exec(l))k.viewportAnchorX=Number(h[1]),k.viewportAnchorY=Number(h[2]);else if(/^scroll:up$/.exec(l))k.scroll="up";else{k=!1;break a}k=!0}k||_.C("VTT parser encountered an invalid VTTRegion setting: ",g,Ju);Qu(e);g=Pu(e)}e=d;b.push(e)}f=[];for(var m of c)if(/^style/.test(m.toLowerCase())){e=m.replace(/^style/i,"").replace(/\n/g," ");d=/[^{}]+{[^{}]*}/g;do(g=d.exec(e))&&f.push(g[0]);while(g)}m=[];for(const n of c)if(n.includes("--\x3e")){a:{l=
n.split("\n");h=a;c=b;if(1===l.length&&!l[0]||/^NOTE($|[ \t])/.test(l[0])||"STYLE"===l[0]){c=null;break a}e=null;l[0].includes("--\x3e")||(e=l[0],l.splice(0,1));d=new _.Ki(l[0]);g=Su(d);const q=_.Ji(d,/[ \t]+--\x3e[ \t]+/g);k=Su(d);if(null==g||null==q||null==k)throw new _.H(_.F,2,2001);g+=h;k+=h;l=l.slice(1).join("\n").trim();g=new _.Bs(g,k,l,_.ug);e&&(g.id=e);Qu(d);for(k=Pu(d);k;)Uu(g,k,c)||_.C(Ku,k,Ju),Qu(d),k=Pu(d);null!=e&&(g.id=e);c=g}c&&m.push(c)}return{cues:m,styles:f}}};var $u=class extends Zu{parseMedia(a,b){return super.parseMedia((new Xu).a(a),b)}};var av=class{constructor(){this.a=null;this.g=new _.R("clpp.vtt.mp4")}parseInit(a){let b=!1;(new _.Ml).M(_.Be,_.Fl).M(_.Yf,_.Fl).M(_.we,_.Fl).ca("mdhd",c=>{0===c.version?(c.reader.skip(4),c.reader.skip(4),this.a=_.P(c.reader),c.reader.skip(4)):(c.reader.skip(8),c.reader.skip(8),this.a=_.P(c.reader),c.reader.skip(8));c.reader.skip(4)}).M(_.Ae,_.Fl).M(_.Pf,_.Fl).ca(_.Rf,_.Gl).M("wvtt",()=>{b=!0}).parse(a);if(!this.a)throw new _.H(_.F,2,2008);if(!b)throw new _.H(_.F,2,2008);}parseMedia(a,b){if(!this.a)throw this.g.error("No init segment for MP4+VTT!"),
new _.H(_.F,2,2008);let c=0,d=[],e;const f=[];let g=!1,h=!1,k=!1,l=null;(new _.Ml).M("moof",_.Fl).M("traf",_.Fl).ca("tfdt",q=>{g=!0;c=0===q.version?_.P(q.reader):_.Al(q.reader)}).ca("tfhd",q=>{var u=q.flags;q=q.reader;q.skip(4);u&1&&q.skip(8);u&2&&q.skip(4);l=u&8?_.P(q):null}).ca("trun",q=>{h=!0;{var u=q.version,v=q.flags;q=q.reader;const y=_.P(q);v&1&&q.skip(4);v&4&&q.skip(4);const B=[];for(let D=0;D<y;D++){const M={duration:null,sampleSize:null,Je:null};v&256&&(M.duration=_.P(q));v&512&&(M.sampleSize=
_.P(q));v&1024&&q.skip(4);v&2048&&(M.Je=0===u?_.P(q):_.zl(q));B.push(M)}d=B}}).M(_.ve,_.Hl(q=>{k=!0;e=q})).parse(a);if(!k&&!g&&!h)throw new _.H(_.F,2,2008);a=c;var m=new DataView(e.buffer,e.byteOffset,e.byteLength);m=new _.ym(m,!1);for(const q of d){const u=q.duration||l,v=q.Je?c+q.Je:a;a=v+(u||0);let y=0;do{const B=_.P(m);y+=B;var n=_.P(m);n=_.El(n);let D=null;"vttc"===n?8<B&&(D=_.Cl(m,B-8)):("vtte"!==n&&this.g.error("Unknown box "+n+"! Skipping!"),m.skip(B-8));u?D&&f.push(Wu(D,b.periodStart+v/this.a,
b.periodStart+a/this.a)):this.g.error("WVTT sample duration unknown, and no default found!")}while(q.sampleSize&&y<q.sampleSize)}return{cues:f.filter(_.Ih),styles:[]}}};_.z("clpp.vtt.VttComponent",class extends _.Yt{constructor(){super();this.j=new Yu}f(){_.gs(_.Vf,Zu);_.gs(Nu,Zu);_.gs(Ou,Zu);_.gs(_.Cc,av);_.gs(Mu,$u);_.gs(Lu,$u);_.Dj.push(this.j)}a(){_.is(_.Vf);_.is(Nu);_.is(Ou);_.is(_.Cc);_.is(Mu);_.is(Lu);_.Fj(this.j)}id(){return"subtitles-vtt"}});};f.call(g, window);